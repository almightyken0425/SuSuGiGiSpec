# 匯入精靈畫面: ImportWizardScreen

## 畫面目標

- **提供:** 從 CSV 檔案批次匯入交易或轉帳紀錄的引導式流程
- **支援:** 兩種匯入模式
    - Transaction 模式: 匯入收入或支出紀錄
    - Transfer 模式: 匯入帳戶間轉帳紀錄
- **確保:** 使用者充分了解匯入格式與時區設定
- **提供:** 清晰的驗證回饋機制

---

## 設計原則

- **模板導向:** 提供標準化的 CSV 模板下載，確保使用者理解預期格式
- **預先驗證:** 在正式匯入前完成所有欄位格式驗證，避免匯入失敗
- **智慧配對:** 自動篩選合規欄位，排除不符合預期格式的對應選項
- **時區一致:** 匯入資料的日期將依據 PreferenceScreen 設定的時區解析
- **日期格式嚴格:** 僅接受 YYYY-MM-DD 格式，確保月日判斷無歧義

---

## 流程步驟摘要

- **Step 0:** 模板與時區提示
- **Step 1:** 檔案選擇
- **Step 2:** 欄位對應與驗證
- **Step 3:** 帳戶與類別比對
- **Step 4:** 預覽與確認匯入

---

## UI 佈局

### 共用元件

- **Header:**
    - `ModalFormHeader`
    - `關閉按鈕` 位於左側
    - `標題` 依當前步驟動態顯示
- **底部導航列:**
    - `返回按鈕`
        - **可見性:** Step 0 不顯示
    - `下一步按鈕`
        - **啟用條件:** 當前步驟驗證通過
        - **文字:** 最後一步顯示 開始匯入

---

### Step 0: 模板與時區提示

- **目標:** 讓使用者了解匯入格式與時區設定
- **UI 結構:**
    - **時區提示區塊:**
        - `標題` 時區設定
        - `說明文字` 匯入的日期時間將依據您目前的時區設定解析
        - `當前時區顯示` 例如 Asia/Taipei UTC+8
        - `前往設定連結`
            - **導航:** PreferenceScreen
    - **模板下載區塊:**
        - `標題` 下載 CSV 模板
        - `說明文字` 下載標準格式範例檔案，確保您的資料符合匯入規範
        - **IF Transaction 模式:**
            - `下載交易模板按鈕`
        - **IF Transfer 模式:**
            - `下載轉帳模板按鈕`
    - **格式說明區塊:**
        - `標題` 必要欄位說明
        - **IF Transaction 模式:**
            - `transaction_datetime` 日期時間，格式為 YYYY-MM-DD 或 YYYY-MM-DD HH:MM:SS，必填
            - `category` 類別名稱，必填
            - `account` 帳戶名稱，必填
            - `amount` 金額，正數為收入，負數為支出，必填
            - `currency` 貨幣代碼，例如 TWD，必填
            - `note` 備註，可選
        - **IF Transfer 模式:**
            - `transfer_datetime` 日期時間，格式為 YYYY-MM-DD 或 YYYY-MM-DD HH:MM:SS，必填
            - `from_account` 轉出帳戶名稱，必填
            - `from_currency` 轉出貨幣代碼，必填
            - `from_amount` 轉出金額，必填
            - `to_account` 轉入帳戶名稱，必填
            - `to_currency` 轉入貨幣代碼，必填
            - `to_amount` 轉入金額，必填
            - `note` 備註，可選

---

### Step 1: 檔案選擇

- **目標:** 讓使用者選擇要匯入的 CSV 檔案
- **UI 結構:**
    - **初始狀態:**
        - `說明文字` 僅支援 UTF-8 編碼的 CSV 檔案
        - `選擇檔案按鈕`
            - **觸發:** 開啟系統檔案選擇器
    - **已選擇檔案:**
        - `檔案名稱`
        - `檔案大小` 以 KB 為單位
        - `重新選擇按鈕`
- **檔案類型驗證:**
    - **檢查:** 副檔名是否為 .csv
    - **IF 非 CSV 檔案:**
        - **行為:** 顯示 Alert 錯誤訊息 僅支援 CSV 格式的檔案
        - **行為:** 維持初始狀態，不接受該檔案
- **進入下一步條件:**
    - 已選擇有效的 CSV 檔案且副檔名為 .csv

---

### Step 2: 欄位對應與驗證

- **目標:** 配對 CSV 欄位與系統欄位，並即時驗證資料格式
- **UI 結構:**
    - **欄位對應列表:**
        - 每個必填系統欄位顯示一列
        - `欄位名稱` 例如 日期時間、金額、類別
        - `必填標記` 以星號標示
        - `可用欄位清單`
            - **內容:** 列出所有通過該欄位格式驗證的 CSV Header
            - **IF 無可用欄位:** 顯示紅色文字 無符合格式的欄位
        - `預覽值` 顯示首筆資料的對應值
    - **驗證錯誤摘要區塊:**
        - **可見性:** 當有欄位驗證失敗時顯示
        - `錯誤標題` 以下欄位未通過驗證
        - `錯誤列表`
            - 每項顯示欄位名稱與錯誤原因
            - 例如 transaction_datetime 欄位: 發現 15 筆無效日期格式

#### 欄位篩選邏輯

- **日期時間欄位 transaction_datetime, transfer_datetime:**
    - **合規條件:** 100% 的資料列符合完整格式
    - **完整格式定義:** YYYY-MM-DD 或 YYYY-MM-DD HH:MM:SS
    - **正則表達式:** `^\d{4}-\d{2}-\d{2}$` 或 `^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$`
    - **格式說明:** 僅接受 ISO 8601 格式，年在前月日在後，避免歧義
    - **不合規範例:** MM/DD/YYYY、YYYY-MM-DD H:MM:SS、純數字
- **金額欄位 amount, from_amount, to_amount:**
    - **合規條件:** 100% 的資料列為可解析的數值
    - **數值定義:** 可包含小數點，可包含正負號，可包含千分位逗號
    - **排除:** 包含非數值資料的欄位，如貨幣符號或文字
- **貨幣欄位 currency, from_currency, to_currency:**
    - **合規條件:** 100% 的資料列為有效的 ISO 4217 貨幣代碼
    - **驗證方式:** 比對 `assets/definitions/Currency.json` 中的 `alphabeticCode` 欄位
- **文字欄位 category, account, from_account, to_account:**
    - **合規條件:** 欄位存在且非全為空白
    - **排除:** 全為空白的欄位
- **進入下一步條件:**
    - 所有必填欄位已配對
    - 所有已配對欄位驗證通過

---

### Step 3: 帳戶與類別比對

- **目標:** 處理 CSV 中的帳戶與類別名稱與系統既有資料的對應關係
- **UI 結構:**
    - **帳戶比對區塊:**
        - `區塊標題` 帳戶比對
        - 每個 CSV 中出現的帳戶名稱顯示一列
        - `帳戶名稱`
        - `動作選擇器`
            - **IF 完全相符:**
                - **預設值:** 使用既有
                - **選項:** 使用既有、新建、跳過
            - **IF 無相符:**
                - **預設值:** 新建
                - **選項:** 新建、跳過
    - **類別比對區塊:**
        - **可見性:** 僅 Transaction 模式顯示
        - `區塊標題` 類別比對
        - 每個 CSV 中出現的類別名稱顯示一列
        - `類別名稱`
        - `動作選擇器`
            - **IF 完全相符:**
                - **預設值:** 使用既有
                - **選項:** 使用既有、新建、跳過
            - **IF 無相符:**
                - **預設值:** 新建
                - **選項:** 新建、跳過
- **進入下一步條件:**
    - 所有帳戶與類別已設定處理方式

---

### Step 4: 預覽與確認匯入

- **目標:** 顯示匯入摘要，讓使用者確認後執行匯入
- **UI 結構:**
    - **統計摘要卡片:**
        - `總紀錄數` 例如 共 150 筆紀錄
        - `將新建帳戶數` 例如 將建立 2 個新帳戶
        - `將新建類別數` 僅 Transaction 模式顯示
        - `將略過紀錄數` 因帳戶或類別設為跳過
    - **驗證警告區塊:**
        - **可見性:** 當有紀錄將被略過時顯示
        - `警告文字` 部分紀錄將因帳戶或類別設為跳過而不會匯入
    - `準備匯入提示文字`
- **開始匯入按鈕:**
    - **觸發:** 執行匯入流程
    - **執行中:** 顯示 Loading 狀態

---

## 核心邏輯

### 模板下載邏輯

- **觸發:** 點擊下載模板按鈕
- **行為:**
    - 產生標準化的 CSV 模板檔案
    - 包含 Header 列與兩筆範例資料
    - 儲存至使用者裝置的下載目錄
- **Transaction 模板欄位與範例:**
    - **Header:** transaction_datetime,category,account,amount,currency,note
    - **範例一:** 2026-01-21 12:30:00,餐飲,現金,-150.00,TWD,午餐
    - **範例二:** 2026-01-22 09:00:00,薪資,銀行存款,50000.00,TWD,一月薪水
- **Transfer 模板欄位與範例:**
    - **Header:** transfer_datetime,from_account,from_currency,from_amount,to_account,to_currency,to_amount,note
    - **範例一:** 2026-01-21 14:00:00,現金,TWD,10000.00,銀行存款,TWD,10000.00,存款
    - **範例二:** 2026-01-22 10:30:00,銀行存款,TWD,30000.00,美金帳戶,USD,1000.00,換匯

### CSV 解析邏輯

- **觸發:** 使用者選擇檔案後自動執行
- **前置驗證:**
    - 檢查檔案副檔名是否為 .csv
    - **IF 非 CSV:** 顯示 Alert 並拒絕檔案
- **行為:**
    - 使用 PapaParse 解析 CSV 內容
    - 提取 Header 欄位列表
    - 提取所有資料列

### 欄位驗證邏輯

- **觸發:** CSV 解析完成後自動執行
- **驗證項目:**
    - **日期時間格式驗證:**
        - 掃瞄所有資料列的對應欄位
        - 合規正則: `^\d{4}-\d{2}-\d{2}$` 或 `^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$`
        - 統計符合格式的比例
        - **IF 低於 100%:** 標記為驗證失敗，不列入可用欄位
        - **錯誤訊息:** 顯示無效資料筆數
    - **金額格式驗證:**
        - 掃瞄所有資料列的對應欄位
        - 移除千分位逗號後嘗試解析為數值
        - 統計可解析為數值的比例
        - **IF 低於 100%:** 標記為驗證失敗，不列入可用欄位
    - **貨幣格式驗證:**
        - 掃瞄所有資料列的對應欄位
        - 比對 ISO 4217 貨幣代碼清單
        - 統計符合的比例
        - **IF 低於 100%:** 標記為驗證失敗，不列入可用欄位
    - **必填欄位驗證:**
        - 檢查所有必填欄位是否至少有一個可用欄位

### 日期解析與時區處理

- **時區來源:** 讀取 PreferenceScreen 設定的 `timeZone` 值
- **解析邏輯:**
    - 將 CSV 中的日期字串視為使用者設定時區的本地時間
    - 解析後轉換為 Unix Timestamp 毫秒
    - DB 儲存 Unix Timestamp 毫秒
- **支援格式:**
    - `YYYY-MM-DD HH:MM:SS` 例如 2026-01-21 12:30:00
    - `YYYY-MM-DD` 例如 2026-01-21，時間預設為 00:00:00
    - 其他格式均視為不合規

### 匯入執行邏輯

- **觸發:** 點擊開始匯入按鈕
- **前置作業:**
    - 建立所有標記為 新建 的帳戶
    - 建立所有標記為 新建 的類別
- **紀錄寫入:**
    - 逐筆讀取 CSV 資料
    - 依據配對欄位提取數值
    - 金額轉換為 cents 單位儲存
    - 建立 Transaction 或 Transfer 紀錄
    - **IF 帳戶或類別設為跳過:** 略過該筆紀錄
- **完成後:**
    - 顯示成功 Alert
    - 包含已匯入筆數與略過筆數
    - 關閉匯入精靈返回前一頁

---

## 導航

- **進入:**
    - **來源:** DataManagementScreen
    - **必要參數:**
        - `mode` 值為 transaction 或 transfer
- **退出:**
    - **觸發:** 點擊 Header 關閉按鈕
    - **行為:** 顯示確認對話框
    - **確認後:** 返回 DataManagementScreen
- **關聯導航:**
    - **觸發:** Step 0 點擊前往時區設定
    - **導航:** PreferenceScreen

---

## 多語言

- **步驟標題:**
    - `import.step_0_title` 準備匯入
    - `import.step_1_title` 選擇檔案
    - `import.step_2_title` 欄位對應
    - `import.step_3_title` 資料比對
    - `import.step_4_title` 確認匯入
- **按鈕文字:**
    - `import.next` 下一步
    - `import.start_import` 開始匯入
    - `import.download_template` 下載模板
    - `import.select_file` 選擇檔案
- **提示文字:**
    - `import.timezone_notice` 匯入的日期時間將依據您目前的時區設定解析
    - `import.template_notice` 下載標準格式範例檔案，確保您的資料符合匯入規範
    - `import.utf8_notice` 僅支援 UTF-8 編碼的 CSV 檔案
    - `import.csv_only_error` 僅支援 CSV 格式的檔案
    - `import.no_valid_columns` 無符合格式的欄位
- **動作選擇器:**
    - `import.action_use_existing` 使用既有
    - `import.action_create_new` 新建
    - `import.action_skip` 跳過
- **驗證錯誤:**
    - `import.validation_error_title` 以下欄位未通過驗證
    - `import.invalid_date_count` {field} 欄位: 發現 {count} 筆無效日期格式
    - `import.invalid_amount_count` {field} 欄位: 發現 {count} 筆無效金額格式
    - `import.invalid_currency_count` {field} 欄位: 發現 {count} 筆無效貨幣代碼
- **成功訊息:**
    - `import.success_title` 匯入完成
    - `import.success_msg` 成功匯入 {added} 筆紀錄，略過 {skipped} 筆

---

