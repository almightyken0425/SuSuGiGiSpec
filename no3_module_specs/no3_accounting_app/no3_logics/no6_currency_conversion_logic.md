# 匯率轉換邏輯: CurrencyConversionLogic

## 邏輯目標

- **定義:** 系統如何處理多幣別之間的金額轉換與報表彙整
- **目的:** 確保使用者在不同介面看到的金額一致且符合直覺

---

## 核心規則

### 基礎貨幣 Base Currency

- **定義:** 總資產與全域報表統一使用的計價單位。
- **來源:** 設定中的基礎貨幣。

### 匯率來源與更新

- **來源:** 取自匯率設定列表。
- **範圍:** 系統僅讀取屬於當前使用者的匯率設定。
- **更新:** 當匯率變更或新增轉帳時，系統會即時重新計算所有相關金額，無需手動重新整理。

### 匯率使用規則

- **策略:** 系統一律使用 **最新的交易對** 進行換算。
- **查找邏輯:**
    - 系統將 原始幣別與基礎幣別 的所有交易對，包含正向與反向，合併並依時間倒序排列。
    - **唯一基準:** 僅採用 **時間最新** 的那一筆匯率紀錄。
- **處理方式:**
    - **若最新紀錄為正向:** 原始幣別 換算至 基礎幣別，則直接使用該匯率。
    - **若最新紀錄為反向:** 基礎幣別 換算至 原始幣別，則取匯率倒數進行換算。
    - **無有效匯率:** 若查無任何紀錄，系統將顯示原始金額。

### 轉帳與匯率連動

- **自動建立:** 當使用者建立跨幣別轉帳時，系統會自動根據輸入的轉出與轉入金額，計算並建立一筆當下的匯率紀錄。
- **影響:** 這筆自動建立的匯率，等同於使用者手動新增的匯率，會立即影響全域的資產換算結果。

---

## 轉帳紀錄顯示列表 Transfer Display Rules

- **前提:** 假設系統基礎貨幣為 **TWD**。
- **情境:** 包含 同幣別轉帳、跨幣別轉帳、雙外幣轉帳。

| 轉帳情境 Flow Context | 當前篩選 Filter | 收支類型 Type | 取用欄位 Field | 顯示幣別與邏輯 Logic |
| :--- | :--- | :--- | :--- | :--- |
| **TWD -> TWD** | 轉出帳戶 TWD | 支出 Expense | 轉出金額 Amount From | **TWD** 不轉換 |
| **TWD -> TWD** | 轉入帳戶 TWD | 收入 Income | 轉入金額 Amount To | **TWD** 不轉換 |
| **TWD -> TWD** | 全域 Global | 支出 Expense | 轉出金額 Amount From | **TWD** 不轉換 |
| | | | | |
| **USD -> TWD** | 轉出帳戶 USD | 支出 Expense | 轉出金額 Amount From | **USD** 不轉換 |
| **USD -> TWD** | 轉入帳戶 TWD | 收入 Income | 轉入金額 Amount To | **TWD** 不轉換 |
| **USD -> TWD** | 全域 Global | 支出 Expense | 轉出金額 Amount From | **TWD** 轉換為基礎幣別 |
| | | | | |
| **TWD -> USD** | 轉出帳戶 TWD | 支出 Expense | 轉出金額 Amount From | **TWD** 不轉換 |
| **TWD -> USD** | 轉入帳戶 USD | 收入 Income | 轉入金額 Amount To | **USD** 不轉換 |
| **TWD -> USD** | 全域 Global | 支出 Expense | 轉出金額 Amount From | **TWD** 不轉換 原始即為基礎幣別 |
| | | | | |
| **USD -> JPY** | 轉出帳戶 USD | 支出 Expense | 轉出金額 Amount From | **USD** 不轉換 |
| **USD -> JPY** | 轉入帳戶 JPY | 收入 Income | 轉入金額 Amount To | **JPY** 不轉換 |
| **USD -> JPY** | 全域 Global | 支出 Expense | 轉出金額 Amount From | **TWD** 轉換為基礎幣別 |
