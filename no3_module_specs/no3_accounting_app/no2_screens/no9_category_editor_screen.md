# 類別編輯器畫面: CategoryEditorScreen

## 畫面目標

- **提供:** 新增或編輯類別的統一介面
- **確保:** 所有自訂類別均映射到標準類別

```text
+--------------------------------+
| Cancel      Title       Done   |
+--------------------------------+
| Name: [ Input Text ]           |
| Map To: [ Standard Cat ] ˅     |
| Icon: [ Icon Preview ] ˅       |
|                                |
| Disable: [ Switch ]            |
|                                |
|           [Delete]             |
+--------------------------------+
```

---

## UI 佈局

- **頂部導航列:**
    - `取消按鈕`
    - `標題`
        - **IF 新增模式:** 新增支出類別或新增收入類別
        - **IF 編輯模式:** 編輯支出類別或編輯收入類別
    - `完成按鈕`
        - **啟用條件:** 所有必填欄位有效
- **核心欄位區:**
    - `類別名稱輸入框`
        - **UI:** 文字輸入框 TextInput
        - **屬性:** 必填
    - `標準類別映射選擇器`
        - **UI:** Inline 展開式選擇器帶搜尋
        - **收合狀態:** 顯示當前所選標準類別名稱與展開指示器 ˅
        - **展開狀態:**
            - 展開指示器變更為 ˄
            - 頂部顯示搜尋文字框，展開時自動 focus
            - 下方顯示標準類別列表區域
            - 列表固定高度可容納 4 個項目
            - 列表內部可滾動
        - **資料來源:** StandardCategory.json
        - **列表過濾:** 依 categoryType 過濾（支出或收入）
        - **列表顯示格式:** 顯示 defaultName 或依 translationKey 翻譯後的名稱
        - **搜尋行為:**
            - 即時篩選，不區分大小寫
            - 匹配翻譯後的類別名稱
            - 搜尋框為空時顯示所有符合 categoryType 的標準類別
        - **選擇行為:** 點擊項目後自動收合並清除搜尋文字
        - **收合方式:** 點擊項目、點擊外部區域、或點擊 ˄
        - **屬性:** 必填
    - `圖示選擇器`
        - **UI:** Inline 展開式選擇器
        - **收合狀態:** 顯示當前所選圖示預覽與展開指示器 ˅
        - **展開狀態:** 
            - 展開指示器變更為 ˄
            - 下方顯示圖示網格區域
            - 網格固定高度可容納 4 行圖示
            - 網格內部可滾動
        - **資料來源:** IconDefinition.json，依 type 過濾 expense 或 income 類型
        - **選擇行為:** 點擊圖示後自動收合並更新預覽
        - **收合方式:** 點擊圖示、點擊欄位外部區域、或點擊 ˄
        - **屬性:** 必填
- **停用開關區:**
    - `停用開關` Switch 元件
    - **標題:** 停用此類別
    - **可見性:** 僅編輯模式顯示
    - **邏輯:** 讀取 `disabledOn` 欄位狀態決定開關預設值
- **刪除按鈕區:**
    - `刪除按鈕`
        - **樣式:** 紅色文字 刪除此類別
        - **可見性:** 僅編輯模式顯示

---

## 核心邏輯

- **模式判斷:**
    - **觸發:** 畫面載入
    - **判斷依據:** 導航參數 `categoryId`
    - **IF 有 categoryId 編輯模式:**
        - **讀取:** 從本機 DB 讀取類別資料填入表單
    - **IF 無 categoryId 新增模式:**
        - **預設:** categoryType 預設為支出
- **儲存邏輯:**
    - **觸發:** 點擊儲存按鈕
    - **IF 新增模式:**
        - **付費牆檢查:**
            - **檢查:**
                - `PremiumLogic.checkPremiumStatus()` 狀態
                - 本機 DB 類別數量
            - **IF 免費版 AND 類別數量已達上限:**
                - **導航:** PaywallScreen
            - **ELSE:**
                - **寫入:** 本機 DB 建立新記錄
                - **欄位:** 必須設定 `updatedOn`
    - **IF 編輯模式:**
        - **IF 停用開關開啟:**
            - **欄位:** `disabledOn` 設為當前時間戳記
        - **IF 停用開關關閉:**
            - **欄位:** `disabledOn` 設為 null
        - **更新:** 本機 DB 該筆記錄
        - **欄位:** 必須更新 `updatedOn`
    - **成功後:**
        - **導航:** 關閉畫面，返回 CategoryListScreen
- **刪除邏輯:**
    - **觸發:** 點擊刪除按鈕
    - **行為:** 顯示確認對話框
    - **提示:** "刪除此類別將一併刪除所有相關的交易紀錄，此動作無法復原。"
    - **成功後:**
        - **軟刪除類別:** 設定本機 DB 該筆 `Category` 的 `deletedOn` 欄位
        - **連動刪除交易:** 搜尋所有 `categoryId` 為此類別的 `Transactions` 並設定 `deletedOn`
        - **更新時間:** 所有受影響資料皆需更新 `updatedOn`
        - **導航:** 關閉畫面，返回 CategoryListScreen

---

## 導航

- **進入:**
    - **來源:** CategoryListScreen
    - **必要參數:** categoryType 支出或收入
    - **可選參數:** categoryId 用於編輯模式
- **退出:**
    - **觸發:** 點擊關閉按鈕或儲存/刪除成功
    - **導航:** 返回上一頁