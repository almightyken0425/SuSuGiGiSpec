# 核心功能

_(本文件定義 App 的主要功能邏輯與規格)_

## 資料流 (Data Flow) - 基礎

- **新增交易/轉帳後:**
    
    - 資料儲存 (本地 DB / 同步至 Firestore)。
        
    - 觸發狀態更新 (例如：更新 Redux/Zustand store 或 Context)。
        
    - App 導航返回首頁 (`HomeScreen`)。
        
    - `HomeScreen` 偵測到相關狀態變動 (透過 selector 或 context consumer)，重新觸發 `useMemo` 計算。
        
    - 重新計算當前報表設定下的總計、圖表數據、近期列表數據。
        
    - UI 重新渲染，顯示最新狀態。
        

## 多幣別處理 (Multi-Currency)

- **預設/基礎貨幣 (Base Currency):**
    
    - **初始化:** 依裝置地區設定預設 (免費版僅能使用此貨幣)。
        
    - **使用者設定:** 可在「設定」中更改 (免費版僅能更改，不能新增)。
        
- **帳戶建立流程 (付費版):**
    
    - 當使用者建立的帳戶幣別與「基礎貨幣」不同時，**必須**輸入該貨幣對「基礎貨幣」的初始匯率。
        
    - **需明確告知使用者：** "此匯率將用於未來報表換算。報表計算時，將**一律採用您為該貨幣對輸入的最新一筆匯率記錄**。"
        
    - 將使用者輸入的初始匯率存入 `CurrencyRates`，`RateDate` 設為當前日期 (UTC Unix Timestamp ms，建議為該日 00:00:00 UTC)。
        
- **報表顯示邏輯:**
    
    - **目標:** 首頁報表（總計、圖表）的顯示幣別，應依據篩選的帳戶決定。若篩選的所有帳戶為同一幣別，則以該幣別顯示；若篩選的帳戶包含多種幣別，則統一換算為「基礎貨幣」顯示。
        
    - **計算方式 (細化):**
        
        - **確定篩選條件:** 根據使用者在首頁選擇的時間粒度、具體時間區間 (基於使用者設定時區計算 UTC 範圍)，以及納入統計的帳戶列表 (由首頁的「帳戶篩選器」決定)。

        - **遍歷記錄:** 程式迭代處理**所有**使用者的 `Transactions` 和 `Transfers` 列表/表格（通常指本地快取/DB 中的數據）。
            
        - **條件篩選:** 對於每一筆記錄，執行以下檢查：
            
            - **時間符合:** `TransactionDate` (UTC ms) 是否落在選定的 UTC 時間範圍內？
                
            - **帳戶符合:** `AccountId` (或 `AccountFromId`/`AccountToId`) 是否在選定的帳戶列表中？
                
            - **未刪除:** `DeletedOn` 是否為 `null`？
                
        - **納入計算的記錄:** 只有**同時滿足**上述所有條件的記錄，才進入下一步的價值計算。
            
        - **價值計算 (換算為基礎貨幣):**
            
            - **判斷記錄類型:** 檢查該筆記錄是 `Transaction` 還是 `Transfer`。
                
            - **若是「轉帳 (Transfer)」:**
                - **情境:** 處理帳戶間的資金移動。
                - **計算邏輯:**
                    - **若轉出帳戶 (`AccountFromId`) 在篩選範圍內:** 視為一筆支出，計入總支出。
                    - **若轉入帳戶 (`AccountToId`) 在篩選範圍內:** 視為一筆收入，計入總收入。
                    - **注意:** 如果轉出和轉入帳戶**同時**在篩選範圍內，此筆轉帳的收支將會互相抵銷，對「總結餘」的影響為零，符合內部流動的本質。但若只篩選單一帳戶，則能正確反映該帳戶的現金流出或流入。
            - **若是「收支 (Transaction)」:**
                - **情境:** 處理對外的收入或支出。
                - **計算邏輯 (針對非基礎貨幣交易):**
                    - 取得交易帳戶的貨幣ID (`fromCurrencyId`) 和基礎貨幣ID (`baseCurrencyId`)。
                    - 在 `CurrencyRates` 中查找符合 `UserId`, `CurrencyFromId` = `fromCurrencyId`, `CurrencyToId` = `baseCurrencyId`, `DeletedOn` is `NULL` 的匯率記錄。
                    - 按 `RateDate` **降冪排列 (DESC)**，選取**最新的一筆**匯率 (`LIMIT 1`)。
                    - 使用此最新匯率 (`latestRate.RateCents`) 將 `tx.AmountCents` 換算成基礎貨幣的 Cents 值。
                
        - **金額加總:** 將所有基礎貨幣交易的金額，以及經過換算的非基礎貨幣交易金額（均以基礎貨幣的 Cents 表示），根據其 `CategoryType` 分別加總。
            
        - **計算結餘:** 總收入 - 總支出。
            
- **逐筆紀錄列表顯示:**
    
    - 金額顯示原始幣別及符號。
        
    - (可選) 顯示換算後的基礎貨幣金額。

> **PM 註記：匯率設計原則**
> 
> - **報表計算分離:** 報表在計算總資產時，`Transfers` 的價值流動是基於 `AmountFromCents`/`AmountToCents` 直接計算的；`CurrencyRates` 表中的匯率主要用於換算**非基礎貨幣**的 `Transactions` (收支)。
> - **自動記錄 (私下匯率):** 「跨幣別轉帳」會自動將該筆交易的隱含匯率新增至 `CurrencyRates` 表。這能即時更新匯率，但也可能記錄到使用者「私下換匯」的特殊匯率。
> - **手動覆蓋 (市場匯率):** 因此，系統仍須提供手動管理匯率的功能，允許使用者隨時輸入一筆新的「市場匯率」。這筆新匯率將會成為最新的有效匯率，用以覆蓋舊的匯率，確保未來的 `Transactions` 換算能採用更準確的市場價值。
> - **不串接 API:** 基於 MVP 的成本、效能考量，以及 App 不回溯歷史資產價值的定位（報表一律採用最新的匯率），決定不串接第三方匯率 API。
        

## 報表功能 (Report)

- **主要報表 (首頁):**
    
    - 預設為首頁的儀表板卡片 (摘要視圖) 中的甜甜圈圖。
        
    - **預設顯示:** App 打開時，儀表板應**預設選取所有帳戶**來顯示匯總數據，時間粒度預設為當日 (`daily`) (基於使用者設定時區)。
        
    - 數據內容與互動如首頁畫面規格所述。

- **進階報表:** (未來考量) 更詳細的報表頁面。
    

## 使用者認證與同步 (Auth & Sync)

- **登入方式:** **強制 Google 快速登入**，Email 作為 `UserId`。 (已移除 Apple 登入以簡化帳號連結問題)。
    
- **架構模型:** 採用「**本地優先 (Local-First)**」架構。App 所有的讀取 (Read) 與寫入 (Write) 操作，**一律**針對「**本機資料庫 (Local DB)**」。
    
- **資料同步:**
    - **雲端角色:** Firebase Firestore 不再是即時資料來源，而是作為付費版使用者的「**被動備份與同步伺服器**」。
    - **同步模型:** 採用「**增量批次同步 (Delta Batch Sync)**」模型，僅在特定時機（每日自動或手動觸發）同步自上次同步以來發生變更的資料。
        
- **首次登入流程:**
    
    - App 啟動 -> 導向登入畫面。

    - Google 登入成功，取得 `UserId` (Email)。

    - **若為新用戶:**
        - **動作:** 在**本機資料庫 (Local DB)** 建立預設資料（基礎貨幣、時區、預設帳戶、預設類別等）。
        - **注意:** **不執行**任何雲端上傳或同步。

    - **若為舊用戶:**
        - **動作:** **不執行**任何操作。
        - **注意:** 資料將在使用者升級為 Premium 並觸發「首次同步」（例如手動按「立即同步」）時才會從雲端下載。

    - 導航至首頁。

### 多裝置同步策略 (Multi-Device Sync Strategy)

-   **策略:** App **支援**使用者在多個裝置上同時登入（例如手機、平板），不採用強制單一裝置登出的機制，以提供無縫的跨裝置體驗。
-   **理由:**
    -   **使用者體驗:** 強制登出會在使用多裝置的現代情境下，造成嚴重的操作摩擦。
    -   **離線情境:** 強制單一裝置登入無法解決「離線操作後，重新連網」所引發的資料狀態不一致問題。
-   **技術實現:** 為了支援穩健的多裝置同步，核心資料表（如 `CurrencyRates`）採用「只增不改 (Append-Only)」的日誌模式。這從根本上避免了因 `UPDATE` 操作在不同裝置間可能引發的「競爭條件 (Race Condition)」，簡化了同步邏輯。


## AI 分析整合

- **定位:** 非 MVP 功能。
    
- **觸發點:** 設定開關 或 首頁健檢按鈕。
    
- **使用者同意:** 強制要求。
    
- **互動方式:** Modal 視窗。
    
- **資料欄位:** 現有欄位足夠，無需預留。
    
- **需後續評估:** 價值、成本、付費意願。
    

## 設定功能 (Settings)

- **第一層入口:** 類別管理, 帳戶管理, 匯率管理, 偏好設定。
    
- **偏好設定 (第二層):**
    
    - **語系 (Language):** 切換顯示語言。
        
    - **主要貨幣 (Base Currency):** 設定基礎貨幣。
        
    - **時區 (Time Zone):**
        
        - **功能:** 設定用於日期計算和顯示的**「主要時區」** (預設自動偵測裝置時區，儲存 IANA ID)。
            
        - **應用 (重要):**
            
            - **顯示:** App 內所有顯示的日期時間，均應使用此「主要時區」來格式化 UTC 時間戳記。
                
            - **計算:** 所有報表（日/週/月）的時間邊界（00:00 - 23:59）均應以此「主要時區」為準進行計算。
                
            - **定期交易:** `lastRecurringCheckDate` 的檢查應基於此「主要時區」的「今天」日期。
                
        - **出國情境:**
            
            - **查看資料:** App **忽略**裝置當前的旅行時區，**始終**使用「主要時區」顯示，確保報表和歷史記錄一致性。
                
            - **新增資料:** 新增交易時，日期選擇器預設為裝置當下的本地時間（例如 'Asia/Tokyo 11:00'）。儲存時，App 將此時間轉換為 **UTC 時間戳記** (e.g., 02:00 UTC) 存入 `TransactionDate`。查看時，此 02:00 UTC 會被「主要時區」('Asia/Taipei') 格式化為 '10:00'。
                
    - **資料同步 (Data Sync) -** _**[付費功能]**_**:**
        - **立即同步 (Sync Now):** 提供手動觸發與雲端同步的按鈕，為付費功能，並包含冷卻機制。
        
    - **帳號 (Account):**
        - **登出:** 提供登出按鈕，點擊後觸發登出流程。
        
## 定期交易 (Recurring Transactions)

- **設定入口:** 新增/編輯 交易/轉帳 頁面，設定頻率、起訖日。
    
- **建立邏輯:**
    - 當使用者在 `TransactionEditorScreen` 中設定並儲存一個新的定期交易時：
        - 在 `Schedules` 表中建立一筆新的排程記錄。
        - **立即**為該排程的 `StartOn` 日期產生第一筆交易實例 (`Transaction` 或 `Transfer`)。

- **資料儲存 (`Schedules` Table):**
    
    - 直接儲存模板信息 (包含 `IsTransfer`, `TemplateAmountCents/From/To`, `TemplateCategoryId`, `TemplateAccountId/From/To`, `TemplateNote`)。
        
- **補產生邏輯 (App 啟動時檢查):**
    
    - 本地記錄 `lastRecurringCheckDate` (日期，基於使用者「主要時區」)。
        
    - 若 `currentDateInUserTZ` (使用者「主要時區」的今天) > `lastRecurringCheckDate`，則執行。
        
    - 遍歷有效 `Schedules`。
        
    - 計算 `lastRecurringCheckDate` (不含) 到 `currentDateInUserTZ` (含) 間應產生的日期 (`instanceDate` - 指該時區的日期，但儲存用 UTC ms)。
        
    - **檢查重複 (簡化 - "存在即跳過"):**
        
        - 檢查 `Transactions`/`Transfers` 表是否已存在 (**不論 `DeletedOn` 狀態**) `ScheduleId` + `ScheduleInstanceDate` = `instanceDate`（對應的 UTC ms）的記錄。
            
    - **產生交易:**
        
        - **若不存在:** 使用 `Schedule` 模板創建新記錄（包含 `ScheduleId`、`ScheduleInstanceDate`，且 `TransactionDate` 設為 `instanceDate` 對應的 UTC ms）。
            
        - **若已存在:** **跳過**，不執行任何操作。
            
    - 更新 `lastRecurringCheckDate` 為 `currentDateInUserTZ` 對應的日期標記。
        
- **編輯/刪除行為:** 當使用者對一筆由定期交易所產生的交易 (`ScheduleInstanceDate` 非空) 操作時：
    
    - 彈出選項: **「僅此一筆」** / **「此筆及未來所有」**。

    - **「僅此一筆」編輯:** 直接修改該筆 `Transaction` / `Transfer` 記錄（使用者可修改 `TransactionDate`, `AmountCents` 等）。App 的生成邏輯會因為記錄已存在而自動跳過，保留使用者的修改。
        
    - **「僅此一筆」刪除:** 直接軟刪除 (設定 `DeletedOn`) 該筆 `Transaction` / `Transfer` 記錄。App 的生成邏輯會因為記錄已存在（雖然被軟刪除）而自動跳過，使其保持刪除狀態。
        
    - **「此筆及未來所有」編輯:**
        
        - 將原 `Schedule` 的 `EndOn` 設為此交易日期的前一個週期日期（例如，月繳的 10/15 號交易，`EndOn` 設為 10/14 號）。
            
        - 根據新內容創建一個**新的 `Schedule`**，`StartOn` 為此交易日期 (`TransactionDate` 或 `ScheduleInstanceDate`)。

        - **不修改**任何歷史 `Transaction` / `Transfer` 記錄。
            
    - **「此筆及未來所有」刪除:**
        
        - 將原 `Schedule` 的 `EndOn` 設為此交易日期的前一個週期日期。

        - **不修改**任何歷史 `Transaction` / `Transfer` 記錄。
            

## 搜尋交易 (Search)

- **邏輯:** 僅搜尋 `Transaction` / `Transfer` 表中的 `Note` 欄位關鍵字。
    

## 匯入資料 (Import)
 
- **(待細化)** CSV 匯入交易。    

## 快速捕捉小工具 (Widgets)

- **說明:** 此功能非 MVP 範疇，詳細規格已移至未來考量文件中。
    
