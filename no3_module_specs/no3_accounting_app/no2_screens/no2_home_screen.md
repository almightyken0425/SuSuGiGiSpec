# 首頁畫面: HomeScreen

## 畫面目標

- **提供:** 使用者財務狀況的即時總覽
- **展示:** 收支分佈圓餅圖與逐筆交易紀錄
- **作為:** 快速新增交易與轉帳的入口
- **支援:** 多幣別換算與時間區間篩選

```text
+---------------------------------------+
| [Filter] [Logo] [Search] [Settings]   |
+---------------------------------------+
|       <  Time Period  >               |
|                                       |
|           Pie Chart                   |
|                                       |
|       Total Balance Area              |
+---------------------------------------+
| (Mode 1: Group by Category)           |
| Expense                               |
| [v] [Icon] Food           TWD 500.00  |
|     USD 10.00                  10/25  |
|     TWD 320 (Converted)               |
|                                       |
|     TWD 180.00                 10/25  |
|                                       |
| Income                                |
| [v] [Icon] Salary       TWD 5,000.00  |
|     TWD 5,000.00               10/01  |
|                                       |
| (Mode 2: Group by Date)               |
| Expense                               |
| [v] Oct 25                TWD 500.00  |
|     Food                   USD 10.00  |
|     Lunch w/ team            TWD 320  |
|                                       |
|     Transport             TWD 180.00  |
|                                       |
| Income                                |
| [v] Oct 01              TWD 5,000.00  |
|     Salary              TWD 5,000.00  |
+---------------------------------------+
| [+] Income [->] Transfer [-] Expense  |
+---------------------------------------+
```

---

## UI 佈局

- **頂部 Header:**
    - `報表篩選按鈕`
    - `Logo`
    - `搜尋按鈕`
    - `設定入口按鈕`
- **主內容區:**
    - **內部結構 - 垂直:**
        - **時間區間標題:**
            - **格式:** 依據 HomeFilterScreen 選擇的時間粒度
                - **Day:** Date With Year
                - **Week:** Date Without Year, Range
                - **Month:** Month With Year
                - **Year:** Year
                - **All:** Date With Year, Range
        - **圓餅圖區塊 PieChart:**
            - **UI 中心:** 顯示 總收入 / 總支出
        - **總餘額區塊 Balance Area:**
            - **UI:** 橫幅, 僅顯示 總結餘
        - **逐筆紀錄區塊 FlatList:**
            - **UI:** 佔據螢幕下方剩餘高度, 內部可垂直滾動
            - **內部結構:**
                - **支出區 Section**
                - **收入區 Section**
            - **分組標題列 Group Header:**
                - **互動:** 可點擊展開/收合單筆紀錄 Row
                - **內部元件:**
                    - **收合圖示:**
                    - **分組標題:**
                        - **IF 按類別分組:** 類別圖示
                        - **IF 按日期分組:** 日期 Date Without Year
                    - **分組金額:** 
                        - **單一幣別:** 顯示該幣別
                        - **多幣別:** 換算為基礎貨幣顯示
            - **單筆紀錄 Row:**
                - **按類別分組:**
                    - **左側:**
                        - **紀錄金額:**
                        - **備註**
                    - **右側:**
                        - **日期:** Date With Year
                - **按日期分組:**
                    - **左側:**
                        - **類別名稱**
                        - **備註**
                    - **右側:**
                        - **紀錄金額:**
- **底部 Footer:**
    - `新增收入按鈕` 圖示 +
    - `新增轉帳按鈕` 圖示 →
    - `新增支出按鈕` 圖示 -

---

## 核心邏輯

- **資料處理 Data Processing:**
    - **圓餅圖區塊:**
        - **聚合:** 依 `categoryId`
        - **過濾:** `當前時間區間` + `所選帳戶`
        - **貨幣邏輯 - 中心:**
            - **單一幣別:** 顯示該幣別
            - **多幣別:** 換算為基礎貨幣顯示
        - **顏色邏輯 - 動態合併:**
            - **排序:** 支出類別依總額降冪排列
            - **合併條件:**
                - 總區塊數 <= 6
                - 總區塊數包含其他類別
                - 獨立顯示類別數 <= 5
            - **提前合併:** 若前 N 類別累計佔比 >= 5/6 且 N < 5，則 N+1 及其後併入 其他
    - **總餘額區塊:**
        - **過濾:** `當前時間區間` + `所選帳戶`
        - **貨幣邏輯:**
            - **單一幣別:** 顯示該幣別
            - **多幣別:** 換算為基礎貨幣顯示
    - **逐筆紀錄區塊:**
        - **來源:** 本機 DB
        - **過濾:** `當前時間區間` + `所選帳戶`
        - **第一層分組:** 固定分為 支出 與 收入 兩個區塊
        - **第二層分組:** 依 Filter Modal 選擇
            - **類別分組:**
            - **日期分組:**
        - **分組金額計算:**
            - **邏輯:** 依 Filter Modal 選擇的帳戶判斷
            - **IF** 所選帳戶皆為同一幣別:
                - **顯示:** 該幣別總和
            - **ELSE** 多種幣別混和:
                - **顯示:** 換算為主要貨幣後的總和
        - **單筆紀錄:**
            - **按類別分組:**
                - **紀錄金額:**
                    - **單一幣別:** 顯示該幣別
                    - **多幣別:** 顯示原始幣別金額 + 主要貨幣換算金額   
            - **按日期分組:**
                - **紀錄金額:**
                    - **單一幣別:** 顯示該幣別
                    - **多幣別:** 顯示原始幣別金額 + 主要貨幣換算金額
        - **排序:**
            - **分組間:** 依總金額降冪
            - **分組內:** 依 `transactionDate` 降冪
- **互動 Interaction:**
    - **逐筆紀錄列表:**
        - **點擊分組:** 展開/收合該分組列表
        - **點擊紀錄:** 導航至編輯畫面
    - **時間區間切換:**
        - **架構:** `主內容區` 為水平分頁 `ScrollView` Paging
        - **頁面:** 每一頁代表一個時間區間實例
        - **手勢:**
            - **左右滑動:** 全螢幕皆可觸發 (包含逐筆紀錄區塊)，整頁切換
            - **垂直滑動:** 僅於 `逐筆紀錄區塊` 觸發
                - **效果:** 列表滾動 + 折疊動畫
        - **限制:** 鎖定向右滑動
            - **提示:** 不可瀏覽未來
        - **資料:** 滑動觸發新頁面 Lazy Load
        - **時間區間標題互動:** 跟隨水平分頁滑動
    - **動畫折疊/展開:**
        - **觸發 - 向上滾動:** 於 `逐筆紀錄區塊` 向上滾動
        - **流程 - 展開列表:**
            - `圓餅圖區塊` 動畫收合
            - `頂部 Header` 向上隱藏
            - `底部 Footer` 向下隱藏
            - `逐筆紀錄區塊` 展開填滿
        - **觸發 - 向下滾動:** 於 `逐筆紀錄區塊` 滾動至頂部
            - **條件:** offset 0
        - **流程 - 恢復圖表:**
            - `圓餅圖區塊` 動畫展開
            - `頂部 Header` 向下顯示
            - `底部 Footer` 向上顯示
            - `逐筆紀錄區塊` 縮回原高
    - **Footer 新增操作權限邏輯:**
        - **觸發:** Footer 支出、收入、轉帳按鈕點擊
        - **流程:**
            - **驗證:** 讀取 `PremiumContext.isPremiumUser`
            - **IF True:** 導航 `TransactionEditorScreen` / `TransferEditorScreen`
            - **IF False:** 執行後續查詢
            - **查詢 - 本機 DB:**
                - `active_accounts` = `Accounts.Count`
                    - **條件:** deletedOn IS null AND disabledOn IS null
                - `active_categories` = `Categories.Count`
                    - **條件:** deletedOn IS null AND disabledOn IS null
            - **判斷:**
                - **IF** `active_accounts <= 3` AND `active_categories <= 10`: 導航 同 IF True 導航
                - **ELSE:** 拒絕導航，顯示 UI 拒絕
            - **UI - 拒絕:** 顯示限制提示 Dialog
                - **內部元件:**
                    - **前往設定按鈕:** 導航 管理畫面
                    - **立即升級按鈕:** 導航 PaywallScreen

---

## 導航

- **新增按鈕導航:**
    - **觸發:** Footer 新增按鈕點擊
    - **流程:**
        - **IF** `HomeScreen` 時間粒度為 daily:
            - **導航:** Editor
            - **參數:** defaultDate
            - **值:** 當前報表日期
        - **ELSE:**
            - **導航:** Editor
            - **參數:** 無 defaultDate