# 帳戶編輯器畫面: AccountEditorScreen

## 畫面目標

- **提供:** 新增或編輯帳戶的統一介面
- **處理:** 新增外幣帳戶時的匯率輸入流程

```text
+--------------------------------+
| Close       Title       Save   |
+--------------------------------+
| Name: [ Input Text ]           |

| Currency: [ TWD ] ˅            |
| Type: [ Standard Type ] ˅      |
| Icon: [ Icon Preview ] ˅       |
|                                |
| Disable: [ Switch ]            |
|                                |
|           [Delete]             |
+--------------------------------+
```

---

## UI 佈局

- **頂部導航列:**
    - `關閉按鈕`
    - `標題`
        - **IF 新增模式:** 新增帳戶
        - **IF 編輯模式:** 編輯帳戶
    - `儲存按鈕`
        - **啟用條件:** 所有必填欄位有效
- **核心欄位區:**
    - `帳戶名稱輸入框`
        - **UI:** 文字輸入框 TextInput
        - **屬性:** 必填

    - `幣別選擇器`
        - **UI:** Inline 展開式選擇器帶搜尋
        - **收合狀態:** 顯示當前所選幣別與展開指示器 ˅
            - 格式: `[alphabeticCode]` 例如 TWD
        - **展開狀態:**
            - 展開指示器變更為 ˄
            - 頂部顯示搜尋文字框，展開時自動 focus
            - 下方顯示幣別列表區域
            - 列表固定高度可容納 4 個項目
            - 列表內部可滾動
        - **資料來源:** Currency.json
        - **列表顯示格式:** `[alphabeticCode]`
        - **搜尋行為:**
            - 即時篩選，不區分大小寫
            - 匹配欄位: alphabeticCode, name
            - 搜尋框為空時顯示所有幣別
        - **選擇行為:** 點擊項目後自動收合並清除搜尋文字
        - **收合方式:** 點擊項目、點擊外部區域、或點擊 ˄
        - **邏輯:** 編輯模式下不可修改
        - **屬性:** 必填
    - `標準帳戶類型選擇器`
        - **UI:** Inline 展開式選擇器
        - **收合狀態:** 顯示當前所選類型名稱與展開指示器 ˅
        - **展開狀態:**
            - 展開指示器變更為 ˄
            - 下方顯示類型列表區域
            - 列表固定高度可容納 4 個項目
            - 列表內部可滾動
        - **資料來源:** StandardAccountType.json
        - **選擇行為:** 點擊項目後自動收合
        - **收合方式:** 點擊項目、點擊外部區域、或點擊 ˄
    - `圖示選擇器`
        - **UI:** Inline 展開式選擇器
        - **收合狀態:** 顯示當前所選圖示預覽與展開指示器 ˅
        - **展開狀態:** 
            - 展開指示器變更為 ˄
            - 下方顯示圖示網格區域
            - 網格固定高度可容納 4 行圖示
            - 網格內部可滾動
        - **資料來源:** IconDefinition.json，依 type 過濾 account 類型
        - **選擇行為:** 點擊圖示後自動收合並更新預覽
        - **收合方式:** 點擊圖示、點擊欄位外部區域、或點擊 ˄
        - **屬性:** 必填
- **停用開關區:**
    - `停用開關` Switch 元件
    - **標題:** 停用此帳戶
    - **可見性:** 僅編輯模式顯示
    - **邏輯:** 讀取 `disabledOn` 欄位狀態決定開關預設值
- **刪除按鈕區:**
    - `刪除按鈕`
        - **樣式:** 紅色文字 刪除此帳戶
        - **可見性:** 僅編輯模式顯示

---

## 核心邏輯

- **模式判斷:**
    - **觸發:** 畫面載入
    - **判斷依據:** 導航參數 `accountId`
    - **IF 有 accountId 編輯模式:**
        - **讀取:** 從本機 DB 讀取帳戶資料填入表單
    - **IF 無 accountId 新增模式:**
        - **準備:** 空表單
- **儲存邏輯:**
    - **觸發:** 點擊儲存按鈕
    - **IF 新增模式:**
        - **付費牆檢查數量:**
            - **檢查:**
                - `PremiumLogic.checkPremiumStatus()` 狀態
                - 本機 DB 帳戶數量
            - **IF 免費版 AND 帳戶數量已達上限:**
                - **導航:** PaywallScreen
        - **付費牆檢查多幣別:**
            - **條件:** 使用者選擇了非基礎貨幣
            - **IF 免費版:**
                - **導航:** PaywallScreen
        - **匯率輸入流程:**
            - **條件:**
                - `PremiumLogic.checkPremiumStatus()` 為 True
                - 選擇了非基礎貨幣
            - **行為:**
                - 彈出介面提示使用者輸入初始匯率
                - 此匯率輸入為必填項
        - **儲存操作:**
            - **IF 涉及匯率輸入:**
                - **批次操作:** 本機 DB 新增 `CurrencyRates` 和 `Account`
                - **欄位:** 兩者都必須設定 `updatedOn`
            - **ELSE:**
                - **寫入:** 本機 DB 建立新 `Account` 記錄
                - **欄位:** 必須設定 `updatedOn`
    - **IF 編輯模式:**
        - **IF 停用開關開啟:**
            - **欄位:** `disabledOn` 設為當前時間戳記
        - **IF 停用開關關閉:**
            - **欄位:** `disabledOn` 設為 null
        - **更新:** 本機 DB 該筆記錄
        - **欄位:** 必須更新 `updatedOn`
    - **成功後:**
        - **導航:** 關閉畫面，返回 AccountListScreen
- **刪除邏輯:**
    - **觸發:** 點擊刪除按鈕
    - **行為:** 顯示確認對話框
    - **提示:** "刪除此帳戶將一併刪除所有相關的交易與轉帳紀錄，此動作無法復原。"
    - **成功後:**
        - **軟刪除帳戶:** 設定本機 DB 該筆 `Account` 的 `deletedOn` 欄位
        - **連動刪除交易:** 搜尋所有 `accountId` 為此帳戶的 `Transactions` 並設定 `deletedOn`
        - **連動刪除轉帳:** 搜尋所有 `fromAccountId` 或 `toAccountId` 為此帳戶的 `Transfers` 並設定 `deletedOn`
        - **更新時間:** 所有受影響資料皆需更新 `updatedOn`
        - **導航:** 關閉畫面，返回 AccountListScreen

---

## 導航

- **進入:**
    - **來源:** AccountListScreen
    - **可選參數:** accountId 用於編輯模式
- **退出:**
    - **觸發:** 點擊關閉按鈕或儲存/刪除成功
    - **導航:** 返回上一頁