# 架構決策與權衡

## 雲端資料庫：Firestore

- **決策:** 付費版功能使用 Google Firestore 作為跨裝置同步與備份的後端
- **決策理由 Pros:**
    - **託管服:** 無需自行維護伺服器、資料庫與 API
    - **認證整合:** 與 Firebase Auth 如 Google 登入無縫整合, 易於管理使用者身份與權限
    - **即時同步:** 若未來決定放棄批次同步, 可改為即時同步模型
    - **開發速度:** 提供強大的 SDK, 加速付費版同步功能的開發
- **考量層面 Cons & Trade-offs:**
    - **成本模型:** 成本與 讀/寫 次數掛鉤, 而非固定月費, 需謹慎設計同步邏輯
    - **廠商鎖定:** 依賴特定廠商的服務, 未來遷移至自建後端的成本較高
    - **資料主權:** 使用者資料儲存在第三方平台, 需在隱私權政策中明確揭露

---

## 匯率：手動維護

- **決策:** 匯率不使用外部 API, 必須由使用者手動輸入或由跨幣別轉帳時自動記錄
- **決策理由:**
    - **核心原則 - 離線運作:** 依賴外部 API 會破壞 App 100% 離線運作的核心架構
    - **成本考量:** 穩定、即時的匯率 API 均需付費, 且費用無法預估
    - **反映真實匯率:** API 無法反映使用者私下換匯的匯率
    - **價值權衡:** 對記帳而言, 現行匯率 的參考價值已足夠, 即時的精確匯率並非核心痛點
    - **簡化架構:** 避免處理 API 失敗、網路中斷、非同步載入等複雜錯誤

---

## 認證：僅 Google 登入

- **決策:** MVP 階段僅支援 Google 登入, 排除 Apple 登入
- **決策理由 Pros:**
    - **簡化開發:** 專注於單一認證流程, 加速 MVP 開發
    - **平台一致性:** Google 登入可同時支援 Android 與 iOS 平台
    - **後端整合:** 與 Firestore 的權限管理可無縫整合
- **考量層面 Cons & Trade-offs:**
    - **iOS 使用者摩擦:** Apple 平台使用者可能更偏好或僅有 Apple ID
    - **App Store 審核風險:**
        - 需注意 Apple 審核指南 4.8 條款
        - 若 App 提供第三方登入如 Google, *可能* 會被要求 *必須* 同時提供 Apple 登入
    - **未來工作:** 若未來追加支援 Apple 登入, 需處理帳號合併或遷移的複雜邏輯

---

## 定期交易：離線漏洞容忍 Offline Loophole Tolerance

- **決策:** 在 App 啟動時依據 **本地資料** 執行定期交易檢查，不強制驗證雲端權限
- **決策理由 Pros:**
    - **離線可用:** 確保使用者在無網路環境下，定期交易仍能正常產生，不中斷記帳體驗
    - **架構一致:** 符合 Local-First 原則，所有寫入優先發生於本地
- **考量層面 Cons & Trade-offs:**
    - **權限漏洞:** 訂閱過期但尚未連網同步的使用者，仍可暫時獲得定期交易產生的新紀錄
    - **接受風險:** 評估此漏洞造成的營收損失極低如惡意斷網操作門檻高，優化使用者體驗的價值更高

---

## 編輯器 UI 一致性：統一在 Editor 管理停用與刪除

- **決策:** 所有編輯器包含 Transaction、Transfer、Account、Category 的停用和刪除功能統一在 Editor 畫面中，而非在 List 畫面使用左滑操作
- **決策理由 Pros:**
    - **操作一致性:** 所有編輯器提供相同的操作模式，降低學習成本
    - **避免手勢衝突:** HomeScreen 已使用左右滑動切換時間區間，Transaction List 若再使用左滑會造成手勢衝突
    - **UI 佈局限制:** Transaction 項目嵌套在分類區塊中，左滑按鈕會卡在分類邊界而非螢幕右側，視覺效果不佳
    - **功能集中:** 編輯類操作包含修改、停用、刪除統一在 Editor 中管理，職責劃分清晰
- **考量層面 Cons & Trade-offs:**
    - **操作步驟:** 需要點擊項目進入 Editor 才能停用或刪除，相比左滑操作多一個步驟
    - **List 畫面功能:** List 畫面職責限縮為瀏覽、查看和排序，不直接提供修改功能
- **職責劃分:**
    - **List 畫面:** 瀏覽、查看、拖拉排序、點擊進入 Editor
    - **Editor 畫面:** 編輯屬性、停用/啟用、刪除項目

---

## Firestore Quota: 使用本地儲存計數 Local Storage

- **決策:** 採用 **本地計數 Local Storage**
- **決策理由 Pros:**
    - **成本效益:** 雲端計數，包含儲存於 Firestore User Document，每次同步需額外讀寫一次，會產生大量無謂的 Quota 消耗，即 Quota Tax。
    - **離線支援:** 本地計數可完美支援離線檢查，不需依賴網路。
- **考量層面 Cons & Trade-offs:**
    - **控制範圍:** 僅能限制單一裝置，無法限制使用者的多裝置總量 Global Limit。
    - **接受風險:** 評估此機制的首要目標是 **防止程式 Bug，例如無窮迴圈** 導致單一裝置失控，而非嚴格限制使用者的多裝置總量，故可接受。
