# 首頁畫面: HomeScreen

## 核心佈局

- **頂部 Header:**
    - **位置:** 螢幕頂部。
    - **可見性:** 随動畫展開或收合。
    - **內部元件:**
        - `報表篩選按鈕`
        - `App 名稱 / Logo`
        - `搜尋按鈕`
        - `設定入口按鈕`
- **主內容區:**
    - **位置:** `頂部 Header` 下方。
    - **內部結構 - 垂直:**
        - `時間區間標題`
        - `圓餅圖區塊`
        - `總餘額區塊`
        - `逐筆紀錄區塊`
- **底部 Footer:**
    - **位置:** 螢幕底部。
    - **內部元件:**
        - `新增收入按鈕` 圖示 +
        - `新增轉帳按鈕` 圖示 →
        - `新增支出按鈕` 圖示 -

---

## 元件定義

### 時間區間標題

- **結構:**
    - **位置:** `頂部 Header` 之下, `圓餅圖區塊` 之上。
    - **UI:** 顯示當前時間區間文字。
- **行為:**
    - **互動:** 跟隨水平分頁滑動。

### 圓餅圖區塊: PieChart

- **結構:**
    - **UI 中心:** 顯示 總收入 / 總支出。
    - **UI 顏色:**
        - **獨立類別:** 上限 7 項。單一色系漸層, 總額最高者最深。
        - **其他:** 該色系最淺色。
- **行為:**
    - **數據:** 支出分佈。
    - **聚合:** 依 `categoryId`。
    - **過濾:** `當前時間區間` + `所選帳戶`。
    - **貨幣邏輯 - 中心:**
        - **單一幣別:** 顯示該幣別。
        - **多幣別:** 換算為基礎貨幣顯示。
    - **顏色邏輯 - 動態合併:**
        - **排序:** 支出類別依總額降冪排列。
        - **合併條件:**
            - 總區塊數: <= 6
            - 備註: 總區塊數包含 "其他"
            - 獨立顯示類別數: <= 5
        - **提前合併:** 若前 N 類別累計佔比 >= 75% 且 N < 5，則 N+1 及其後併入 其他。

### 總餘額區塊: Balance Area

- **結構:**
    - **位置:** `圓餅圖區塊` 與 `逐筆紀錄區塊` 之間。
    - **UI:** 橫幅, 僅顯示 總結餘。
- **行為:**
    - **貨幣邏輯:**
        - **單一幣別:** 顯示該幣別。
        - **多幣別:** 換算為基礎貨幣顯示。
    - **計算:** 必須包含 `Transfer` 記錄。轉出視為支出, 轉入視為收入。

### 逐筆紀錄區塊: FlatList

- **結構:**
    - **UI:** 佔據螢幕下方剩餘高度, 內部可垂直滾動。
    - **內部結構:**
        - 支出區
        - 收入區
    - **項目 UI 內容:**
        - 圖標
        - 類別名稱
        - 金額
        - 幣別: 原始幣別
        - 選填: 帳戶
        - 選填: 備註
    - **項目 UI 換算:**
        - **條件:** 非基礎貨幣
        - **顯示:** 於原始金額下方顯示換算後的基礎貨幣金額
    - **項目 UI 顏色:**
        - **支出區圖示:** 連動 `圓餅圖` 顏色, 總額最高者最深。
        - **收入區圖示:** 統一、固定的主題色。
- **行為:**
    - **數據:** `Transactions` + `Transfers`。
    - **來源:** 本機 DB。
    - **過濾:** `當前時間區間` + `所選帳戶`。
    - **排序 - 通用:**
        - **群組:** 按群組總金額降冪排列。
        - **群組內:** 按 `transactionDate` 降冪, `createdOn` 降冪。
    - **顯示模式:**
        - **屬性:** 可切換。
        - **預設:** 類別分組。
        - **選項: 按類別分組**
            - **聚合:** 依 `categoryId`
            - **互動:** 可展開
        - **選項: 按日期分組**
            - **聚合:** 依 `transactionDate`
            - **互動:** 可展開
    - **監聽:** 即時監聽本機資料庫變更並刷新 UI。
    - **點擊:** 導航 `TransactionEditorScreen` / `TransferEditorScreen`。

---

## 核心互動

### Footer 新增操作權限邏輯

- **觸發:** Footer 支出、收入、轉帳按鈕點擊。
- **流程:**
    - **驗證:** 讀取 `PremiumContext.isPremiumUser`。
    - **IF True:** 導航 `TransactionEditorScreen` / `TransferEditorScreen`。
    - **IF False:** 執行後續查詢。
    - **查詢 - 本機 DB:**
        - `active_accounts` = `Accounts.Count`
            - **條件:** deletedOn IS null AND disabledOn IS null
        - `active_categories` = `Categories.Count`
            - **條件:** deletedOn IS null AND disabledOn IS null
    - **判斷:**
        - **IF** `active_accounts <= 3` AND `active_categories <= 10`: 導航 (同 IF True 導航)。
        - **ELSE:** 拒絕導航，顯示 UI 拒絕。
    - **UI - 拒絕:** 顯示限制提示 Dialog。
        - **內部元件:**
            - **前往設定按鈕**
                - **導航:** 管理畫面
            - **立即升級按鈕**
                - **導航:** PaywallScreen

### 動畫互動: 折疊/展開

- **觸發 - 向上滾動:** 於 `逐筆紀錄區塊` 向上滾動。
- **流程 - 展開列表:**
    - `圓餅圖區塊` 動畫收合。
    - `頂部 Header` 向上隱藏。
    - `底部 Footer` 向下隱藏。
    - `逐筆紀錄區塊` 展開填滿。
- **觸發 - 向下滾動:** 於 `逐筆紀錄區塊` 滾動至頂部。
    - **條件:** offset 0。
- **流程 - 恢復圖表:**
    - `圓餅圖區塊` 動畫展開。
    - `頂部 Header` 向下顯示。
    - `底部 Footer` 向上顯示。
    - `逐筆紀錄區塊` 縮回原高。

### 時間區間切換

- **架構:** `主內容區` 為水平分頁 `ScrollView`, Paging。
- **頁面:** 每一頁代表一個時間區間實例。
- **手勢:**
    - **左右滑動:** 於 `非逐筆紀錄區塊` 觸發，整頁切換。
    - **垂直滑動:** 僅於 `逐筆紀錄區塊` 觸發。
        - **效果:** 列表滾動 + 折疊動畫。
- **限制:** 鎖定向右滑動。
    - **提示:** 不可瀏覽未來。
- **資料:** 滑動觸發新頁面 Lazy Load。

### 報表篩選 Modal: Bottom Sheet

- **觸發:** `頂部 Header` `報表篩選按鈕` 點擊。
- **Modal 頂部導航列:**
    - **內部元件:**
        - **取消按鈕**
            - **行為:** 關閉 Modal，不儲存。
        - **標題**
            - **內容:** 篩選報表
        - **完成按鈕**
            - **行為:** 關閉 Modal，觸發 `HomeScreen` 重新查詢。
- **Modal 內容 - 時間粒度:**
    - **UI:** Segmented Control。
    - **選項:** 日, 週, 月, 年, 全部
        - **屬性:** 單選。
- **Modal 內容 - 帳戶篩選:**
    - **UI:** 多選 Checkbox 列表 + 全選。
    - **邏輯:** 排除 `deletedOn` 或 `disabledOn` 非 `null` 的帳戶。
- **Modal 內容 - 列表分組:**
    - **UI:** Segmented Control。
    - **選項:** 按日期分組, 按類別分組。
- **預設值:**
    - **時間粒度:** 當日, daily。
    - **帳戶篩選:** 僅選取 `sortOrder` 最高的帳戶。
    - **列表分組:** 按類別分組。
- **限制:** 不可選擇未來期間。

### 導航邏輯

- **觸發:** Footer 新增按鈕點擊。
- **流程:**
    - **IF** `HomeScreen` 時間粒度為 daily:
        - **導航:** Editor
        - **參數:** defaultDate
        - **值:** 當前報表日期
    - **ELSE:**
        - **導航:** Editor
        - **參數:** 無 defaultDate