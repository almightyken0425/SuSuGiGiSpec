# 匯率轉換邏輯: CurrencyConversionLogic

## 邏輯目標

- **定義:** 說明系統如何處理多幣別之間的金額轉換與報表彙整
- **目的:** 確保使用者在不同介面看到的金額一致且符合直覺

---

## 核心規則

### 基礎貨幣 Base Currency

- **定義:** 總資產與全域報表統一使用的計價單位。
- **來源:** 設定中的基礎貨幣。

### 匯率來源與更新

- **來源:** 取自匯率設定列表。
- **範圍:** 系統僅讀取屬於當前使用者的匯率設定。
- **更新:** 當匯率變更或新增轉帳時，系統會即時重新計算所有相關金額，無需手動重新整理。

### 匯率使用規則

- **策略:** 系統一律使用 **最新的交易對** 進行換算。
- **查找邏輯:**
    - 系統將 原始幣別與基礎幣別 的所有交易對，包含正向與反向，合併並依時間倒序排列。
    - **唯一基準:** 僅採用 **時間最新** 的那一筆匯率紀錄。
- **處理方式:**
    - **若最新紀錄為正向:** 原始幣別 換算至 基礎幣別，則直接使用該匯率。
    - **若最新紀錄為反向:** 基礎幣別 換算至 原始幣別，則取匯率倒數進行換算。
    - **無有效匯率:** 若查無任何紀錄，系統將預設匯率為 1。

### 轉帳與匯率連動

- **自動建立:** 當使用者建立跨幣別轉帳時，系統會自動根據輸入的轉出與轉入金額，計算並建立一筆當下的匯率紀錄。
- **影響:** 這筆自動建立的匯率，等同於使用者手動新增的匯率，會立即影響全域的資產換算結果。

---

## 轉帳紀錄顯示規則 Transfer Display Rules

- **說明:** 本區段詳列在不同 **錢包篩選** 情境下，系統應如何呈現轉帳紀錄。
- **假設:** 基礎貨幣為 TWD

### 情境 - 只選擇 TWD 帳戶

| 轉帳 | 顯示區域 | 顯示金額 | 換算邏輯 |
| :--- | :--- | :--- | :--- |
| TWD → USD | 支出 | amountFrom TWD | 直接顯示，無需換算 |
| TWD → JPY | 支出 | amountFrom TWD | 直接顯示，無需換算 |
| USD → TWD | 收入 | amountTo TWD | 直接顯示，無需換算 |
| JPY → TWD | 收入 | amountTo TWD | 直接顯示，無需換算 |
| USD → JPY | 不顯示 | - | TWD 不涉及此轉帳 |

---

### 情境 - 只選擇 USD 帳戶

| 轉帳 | 顯示區域 | 顯示金額 | 換算邏輯 |
| :--- | :--- | :--- | :--- |
| USD → TWD | 支出 | amountFrom USD | 查找 USD ↔ TWD 換算 |
| USD → JPY | 支出 | amountFrom USD | 查找 USD ↔ TWD 換算 |
| TWD → USD | 收入 | amountTo USD | 查找 USD ↔ TWD 換算 |
| JPY → USD | 收入 | amountTo USD | 查找 USD ↔ TWD 換算 |
| TWD → JPY | 不顯示 | - | USD 不涉及此轉帳 |

---

### 情境 - 選擇 TWD + USD 帳戶

| 轉帳 | 顯示區域 | 顯示金額 | 換算邏輯 |
| :--- | :--- | :--- | :--- |
| TWD → JPY | 支出 | amountFrom TWD | 直接顯示 |
| USD → JPY | 支出 | amountFrom USD | 查找 USD ↔ TWD 換算 |
| JPY → TWD | 收入 | amountTo TWD | 直接顯示 |
| JPY → USD | 收入 | amountTo USD | 查找 USD ↔ TWD 換算 |
| TWD → USD | 不顯示 | - | 內部轉帳 |
| USD → TWD | 不顯示 | - | 內部轉帳 |

---

### 規則總結

| 條件 | 顯示區域 | 顯示金額 |
| :--- | :--- | :--- |
| 轉出帳戶 ∈ 所選，轉入帳戶 ∉ 所選 | 支出 | amountFrom |
| 轉出帳戶 ∉ 所選，轉入帳戶 ∈ 所選 | 收入 | amountTo |
| 雙方帳戶皆 ∈ 所選 | 不顯示 | 內部轉帳 |
| 雙方帳戶皆 ∉ 所選 | 不顯示 | 無關紀錄 |