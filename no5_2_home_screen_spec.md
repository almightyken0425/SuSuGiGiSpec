# 首頁畫面 (HomeScreen)

_(本文件定義首頁的 UI 佈局、元件與互動邏輯 - 採用「可折疊面板」方案)_

## 核心佈局

- **頂部 Header:**
    
    - **位置:** 螢幕頂部。
        
    - **內容:**
        
        - **App 名稱 (或 Logo):** 位於頂部中央。
            
        - **左側按鈕區:** 包含**一個** `報表篩選按鈕` (例如 "篩選" 或 "調整" 的圖示)。
            
        - **右側按鈕區:** 包含 `設定入口按鈕` (例如齒輪圖標) 和一個 `(未來) 搜尋按鈕` 的預留位置。

            
- **主內容區:**
    
    - **位置:** 頂部 Header 下方。
        
    - **結構:** 垂直排列為以下區域：
        
        - **圓餅圖區塊 (PieChart):**

        - **總餘額與控制區塊:**

        - **逐筆紀錄區塊:**

- **底部 Footer:**
    - **位置:** 固定在螢幕底部。
    - **內容:** 包含三個核心操作按鈕，由左至右排列：
        - **新增收入按鈕 (+):** 點擊後觸發「核心功能鎖」檢查。
        - **新增轉帳按鈕 (→):** 點擊後觸發「核心功能鎖」檢查。
        - **新增支出按鈕 (-):** 點擊後觸發「核心功能鎖」檢查。
    - **核心功能鎖邏輯 (Footer 點擊時):**
        - **檢查 Premium:** 點擊任一新增按鈕時，App 必須立即檢查「**本機狀態 (e.g., PremiumContext)**」中的 `isPremiumUser`。
        - **付費版流程:** 若 `isPremiumUser` 為 `true`，立即導航至對應的編輯器畫面（`TransactionEditorScreen` 或 `TransferEditorScreen`）。
        - **免費版檢查:** 若 `isPremiumUser` 為 `false`，**不得立即導航**，改為執行「有效項目計數」查詢。
        - **計數查詢:** App 查詢「**本機資料庫 (Local DB)**」，計算：
            - `active_account_count` = `Accounts` 表中 `deletedOn` 為 `null` 且 `disabledOn` 為 `null` 的紀錄總數。
            - `active_category_count` = `Categories` 表中 `deletedOn` 為 `null` 且 `disabledOn` 為 `null` 的紀錄總數。
        - **判斷:**
            - **若 `active_account_count <= 3` 且 `active_category_count <= 10` (符合免費版限制):** 允許導航至對應的編輯器畫面。
            - **若 `active_account_count > 3` 或 `active_category_count > 10` (超出免費版限制):** **阻擋導航**。
        - **阻擋 UI:** 阻擋導航時，應彈出一個提示對話框，說明已超出免費版限制，並提供「前往設定」（停用項目）或「立即升級」（導航至 `PaywallScreen`）的選項。


## 主內容區元件詳述

_(此區域的元件會根據動畫互動進行高度調整)_

- **圓餅圖區塊 (`PieChart`):**
    - **圓餅圖 (甜甜圈圖):**
        - **數據:** 視覺化顯示**當前時間區間**內、**所選帳戶**的、按**使用者自訂類別** (`categoryId`) 聚合的支出分佈。
        - **圖表中心:** 應在甜甜圈圖的中心**同時**顯示「**總收入**」和「**總支出**」（例如：NT$0.00 / -NT$58,010.00）。
        - **貨幣顯示邏輯 (總支出與總收入):**
            - 若所有選定的帳戶都使用**相同的貨幣**，則總支出以該貨幣顯示。否則 (即選定的帳戶包含多種貨幣)，總支出與總收入將**換算為基礎貨幣**顯示。

- **總餘額區塊 (Balance Area):**
    - **位置:** 位於**圓餅圖區塊**和**逐筆紀錄區塊**之間。
    - **UI:** 一個獨立、醒目的橫幅，**僅**顯示「**總結餘**」（例如 `Balance -NT$58,010.00`）。
    - **貨幣顯示邏輯:**
        - 若所有選定的帳戶都使用**相同的貨幣**，則總餘額以該貨幣顯示。
        - 否則 (即選定的帳戶包含多種貨幣)，總餘額將**換算為基礎貨幣**顯示。
    - **計算註記:** 此處的「總結餘」計算**必須包含** `Transfer` 記錄，以正確反映所選帳戶範圍的現金流變化。

- **逐筆紀錄區塊 (`FlatList`):**
    
    - **UI:** 預設佔據螢幕下方剩餘高度，此區域**內部可垂直滾動**。
        
    - **數據:** 從「**本機資料庫 (Local DB)**」查詢**當前時間區間**內、**所選帳戶**的交易紀錄 (`Transactions` 和 `Transfers`)。
        
    - **顯示模式 (可切換):** 根據**報表篩選 Modal** 中「列表分組區」的設定顯示：
        
        - **按類別分組模式:** 預設模式。將交易按 `categoryId` 匯總，顯示各類別總金額。此列表應按「類別總額」**降冪排列**（金額大的在最上面），並可點擊展開查看該類別下的交易明細。類別內交易明細應按 `transactionDate` 含 `updatedOn` **降冪排列**。
            
        - **按日期分組模式:** 將交易按 `transactionDate` 匯總，顯示各日期總金額。此列表應按「類別總額」**降冪排列**（金額大的在最上面），並可點擊展開查看該類別下的交易明細。日期內交易明細應按 `transactionDate` 含 `updatedOn` **降冪排列**。
            
    - **交易明細顯示內容:**
        
        - **項目內容:** 顯示圖標、類別名稱、帳戶名稱、備註、**金額 (原始幣別)**。
            
        - **換算金額:** 若該筆交易的幣別**非**基礎貨幣，應在其原始金額下方，以較小字體顯示**換算後的基礎貨幣金額**。
            
        - **監聽變更 (Real-time Update):** 此列表應即時監聽「本機資料庫」的變更。當背景同步或定期交易任務寫入新資料時，UI 應自動刷新。
            
    - **互動 (點擊):**
        
        - **點擊單筆紀錄:** 導航至 `TransactionEditorScreen` 或 `TransferEditorScreen` (包含**管理**定期交易的入口)。


## 核心互動

        
- **時間區間切換:**
    - **架構:** `主內容區 (View)` 本身應實作為一個**水平分頁 (Paging) 的 `ScrollView`**（或 `PagerView`）。
    - **頁面:** `ScrollView` 中的**每一頁**都是一個獨立的儀表板實例，代表一個時間區間（例如 "11月", "12月", "1月"）。每一頁都包含自己的 `圓餅圖區塊`、`總餘額區塊` 和 `逐筆紀錄區塊`。
    - **手勢:**
        - **水平滑動:** 當使用者在**非「逐筆紀錄區塊」**的區域（例如 `圓餅圖區塊` 或 `總餘額區塊`）左右滑動時，觸發**整頁**切換，並顯示 Segue（卡片滑動）動畫。
        - **垂直滑動:** 僅在 `逐筆紀錄區塊` 上觸發，用於滾動列表及連動 Header/Footer 的隱藏動畫。
    - **行為:** 僅允許由當前期間向左（查看過去）滑動；嘗試往右進入今天以後的期間時需鎖定頁面並以 Toast/Banner 提示「不可瀏覽未來」。
    - **資料更新:** 滑動操作會觸發新頁面的載入（Lazy Load）。


- **動畫互動 (折疊/展開):** 
    
    - **向上滾動 (展開列表):** 當使用者在**逐筆紀錄區塊**中向上滾動時，**頂部**、**圓餅圖區塊**、**底部**動畫收合 (例如高度變為 0 或向上滑出螢幕)。**逐筆紀錄區塊**動畫展開以填滿空間，**總餘額與控制區塊**保持可見。
        
    - **向下滾動 (恢復圖表):** 當使用者在 (已展開的)**逐筆紀錄區塊**中向下滾動至列表頂部 (scroll offset 0) 時，觸發反向動畫，**頂部**、**圓餅圖區塊**、**底部**恢復顯示，**逐筆紀錄區塊**縮回原高度。


- **報表篩選 Modal:**
    - **觸發:** 使用者點擊 Header 左側的 `報表篩選按鈕`。
    - **UI:** 彈出一個**底部彈出式 Modal (Bottom Sheet)**。
    - **Modal 內部佈局:**
        - **Modal 頂部導航列:**
            - **元件:** 一個位於 Modal 頂部的標題列。
            - **左側:** 「取消」按鈕（點擊後關閉 Modal，不儲存變更）。
            - **中間:** 標題「篩選報表」。
            - **右側:** 「完成」按鈕 (Done)。
            - **「完成」按鈕邏輯:** 點擊後，Modal 關閉，`HomeScreen` 根據 Modal 內選定的「時間粒度」和「帳戶選項」，重新觸發**「本機資料庫」**的查詢，並更新主內容區的所有數據。
        - **時間粒度區 (Time Granularity) (位於導航列下方):**
            - **元件:** 一個分段控制項 (Segmented Control)。
            - **選項:** "日", "週", "月", "年", "全部"。
            - **邏輯:** 這是單選。
        - **帳戶篩選區 (Account Filter):**
            - **元件:** 一個可滾動的多選列表 (Checkbox list)，包含「全選」選項。
            - **邏輯:** 此列表**必須**排除所有 `deletedOn` 或 `disabledOn` **非 `null`** 的帳戶。
            - **限制:** 此列表**不受**免費版 3 個帳戶的數量限制。
        - **列表分組區 (Grouping Area):**
            - **元件:** 一個新的分段控制項 (Segmented Control)。
            - **選項:** "按日期分組", "按類別分組"。
    - **預設行為:**
        - App 啟動時，時間粒度預設為「當日 (daily)」。
        - 帳戶篩選器預設僅選取 `sortOrder` 最高的帳戶（即 `sortOrder` 最小的項目）。
    - **未來限制:**
        - Modal 內的日期/粒度控制不可跳到今天以後；若使用者嘗試選擇未來期間，需拒絕操作並提示原因。

- **導航邏輯 (Navigation Logic):**
    - 當使用者點擊 Footer 中的新增支出/收入/轉帳按鈕時：
        - **如果**當前 `HomeScreen` 的時間粒度為 `daily`，則導航至 `TransactionEditorScreen` 或 `TransferEditorScreen` 時，需傳入當前報表日期作為 `defaultDate` 參數。
        - **否則**，正常導航，不傳遞日期參數。
