# 匯入畫面規格: ImportScreen

## 畫面目標

- **定位:** 付費功能
- **提供:** 引導式介面, 從 CSV 檔案遷移交易紀錄
- **支援:**
    - CSV 欄位與 App 欄位的映射
    - CSV 內容與 App 內容的配對
    - 自動建立新帳戶與類別

```text
+--------------------------------+
| Step 1/4: Select File          |
+--------------------------------+
|                                |
|      [ Select CSV File ]       |
|      (Supports UTF-8)          |
|                                |
|                                |
|          [ Next ]              |
+--------------------------------+
```

## UI 佈局

- **架構:** 多步驟引導流程, Wizard
- **步驟 1: 檔案選擇**
    - **頂部導航列:**
        - **標題:** 匯入紀錄 1/4
    - **UI:**
        - **選擇 CSV 檔案按鈕**
        - **說明文字:** 支援 UTF-8 編碼
    - **下一步按鈕:**
        - **可見性:** 選擇檔案後才可點擊
- **步驟 2: 欄位映射**
    - **頂部導航列:**
        - **標題:** 欄位映射 2/4
    - **UI:**
        - **目標欄位 App:**
            - 日期，映射至 `transactionDate`
            - 金額
            - 類別名稱
            - 帳戶名稱
            - 備註
        - **來源欄位 CSV:**
            - **UI:** 每個目標欄位旁, 都有一個下拉選單
            - **選項:** 來源 CSV 欄位標頭
    - **邏輯:**
        - App 應嘗試自動猜測配對
    - **下一步按鈕:**
        - **可見性:** 必填欄位 (日期, 金額, 類別, 帳戶) 都完成映射後才可點擊
- **步驟 3: 內容配對**
    - **頂部導航列:**
        - **標題:** 內容配對 3/4
    - **UI:** 畫面分為兩個區塊
        - 帳戶配對
        - 類別配對
    - **帳戶配對區:**
        - **標題:** 請配對您的帳戶
        - **列表:** 顯示 CSV 中所有不重複的 帳戶名稱
        - **項目操作:**
            - **CSV 項目:** 範例 我的信用卡
            - **下拉選單 (操作):**
                - **選項:**
                    - 自動建立新帳戶 "我的信用卡" (預設)
                    - 配對到 -> [富邦J卡]
                    - 配對到 -> [現金]
                    - 略過所有使用此帳戶的交易
    - **類別配對區:**
        - **標題:** 請配對您的類別
        - **列表:** 顯示 CSV 中所有不重複的 類別名稱
        - **項目操作:**
            - **CSV 項目:** 範例 晚餐
            - **下拉選單 (操作):**
                - **選項:**
                    - 自動建立新類別 "晚餐" (預設)
                    - 配對到 -> [餐飲]
                    - 略過所有使用此類別的交易
    - **下一步按鈕:**
        - **可見性:** 所有偵測到的新名稱都選好操作後才可點擊
- **步驟 4: 預覽與匯入**
    - **頂部導航列:**
        - **標題:** 預覽與匯入 4/4
    - **UI:**
        - **摘要資訊:**
            - 將匯入 N 筆交易
            - 將自動建立 M 個新帳戶
            - 將自動建立 K 個新類別
        - **預覽列表:**
            - **顯示:** 前 5-10 筆已配對完成的交易紀錄
            - **格式:** 日期欄位格式 Date Without Year 顯示
        - **警告:**
            - **顯示:** 因格式錯誤而略過的筆數
    - **匯入按鈕:**
        - **標題:** 開始匯入

---

## 核心邏輯

- **付費牆檢查:**
    - **觸發:** 從 SettingsScreen 導航進入前
    - **檢查:** `PremiumContext.isPremiumUser`
    - **IF** False (免費版):
        - **導航:** PaywallScreen
- **CSV 解析:**
    - **觸發:** 步驟 1 -> 2
    - **行為:** 客戶端解析 CSV, 讀取標頭和資料
- **內容分析:**
    - **觸發:** 步驟 2 -> 3
    - **行為:**
        - 依 欄位映射 掃描 CSV 帳戶名稱 和 類別名稱 欄位
        - 建立不重複值列表
        - 比對 本機 DB 現有 `Accounts` 和 `Categories` 名稱, 標記新發現項目
- **匯入執行:**
    - **觸發:** 步驟 4 點擊 開始匯入
    - **流程:**
        - **建立新項目:**
            - **優先:** 依 步驟 3 設定, 批次建立所有新帳戶與類別
            - **來源:** 本機 DB
            - **欄位:** 必須設定 `updatedOn`
        - **匯入交易:**
            - **建立配對地圖:** 於記憶體中建立 CSV名稱 對應 App ID 的地圖
            - **遍歷 CSV:** 逐行轉換為 `Transaction` 物件
            - **寫入:** 批次寫入 本機 DB
            - **欄位:** 必須設定 `updatedOn`
- **匯入完成:**
    - **UI:** 顯示 Modal
    - **提示:** 匯入完成！成功新增 N 筆紀錄、M 個帳戶、K 個類別。
    - **導航:** 點擊 完成 後, 導航回 SettingsScreen

---

## 錯誤處理

- **步驟 1:** 處理檔案類型, 編碼錯誤
- **步驟 2:** 確保必填欄位均被映射
- **步驟 3:** 確保所有新內容都被指派操作
- **步驟 4:** 顯示因資料格式錯誤 (日期, 金額) 而被略過的紀錄行數

---

## 狀態管理

- **本地狀態:**
    - `currentStep`
    - `csvFile`
    - `csvHeaders`
    - `csvData`
    - `columnMapping`
    - `valueMapping`
    - `parsedTransactions`
    - `errorRows`

---

## 導航

- **進入:**
    - **來源:** SettingsScreen
- **退出:**
    - **來源:** 頂部導航列 返回按鈕
    - **來源:** 匯入成功後自動返回