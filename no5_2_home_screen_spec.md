# 首頁畫面 (HomeScreen)

_(本文件定義首頁的 UI 佈局、元件與互動邏輯 - 採用「可折疊面板」方案)_

## 核心佈局

-   **頂部 Header:**
    -   **位置:** 位於螢幕頂部，動畫收合時隱藏，動畫展開時顯示。
    -   **內容:**
        -   **App 名稱 (或 Logo):** 位於頂部中央。
        -   **左側按鈕區:** 包含**一個** `報表篩選按鈕` (例如 "篩選" 或 "調整" 的圖示)。
        -   **右側按鈕區:** 包含 `設定入口按鈕` (例如齒輪圖標) 和一個 `(未來) 搜尋按鈕` 的預留位置。

-   **主內容區:**
    -   **位置:** 位於頂部 Header 下方。
    -   **結構:** 垂直劃分為以下區域：
        -   **時間區間標題 (Time Range Header):**
        -   **圓餅圖區塊 (PieChart):**
        -   **總餘額區塊:**
        -   **逐筆紀錄區塊:**

-   **底部 Footer:**
    -   **位置:** 位於螢幕底部。
    -   **內容:** 包含三個核心操作按鈕，由左至右排列：
        -   **新增收入按鈕 (+):** 點擊後觸發「核心功能鎖」檢查。
        -   **新增轉帳按鈕 (→):** 點擊後觸發「核心功能鎖」檢查。
        -   **新增支出按鈕 (-):** 點擊後觸發「核心功能鎖」檢查。
    -   **核心功能鎖邏輯 (Footer 點擊時):**
        -   **檢查 Premium:** 點擊任一新增按鈕時，App 必須立即檢查「**本機狀態 (e.g., PremiumContext)**」中的 `isPremiumUser`。
        -   **付費版流程:** 若 `isPremiumUser` 為 `true`，立即導航至對應的編輯器畫面（`TransactionEditorScreen` 或 `TransferEditorScreen`）。
        -   **免費版檢查:** 若 `isPremiumUser` 為 `false`，**不得立即導航**，改為執行「有效項目計數」查詢。
        -   **計數查詢:** App 查詢「**本機資料庫 (Local DB)**」，計算：
            -   `active_account_count` = `Accounts` 表中 `deletedOn` 為 `null` 且 `disabledOn` 為 `null` 的紀錄總數。
            -   `active_category_count` = `Categories` 表中 `deletedOn` 為 `null` 且 `disabledOn` 為 `null` 的紀錄總數。
        -   **判斷:**
            -   **若 `active_account_count <= 3` 且 `active_category_count <= 10` (符合免費版限制):** 允許導航至對應的編輯器畫面。
            -   **若 `active_account_count > 3` 或 `active_category_count > 10` (超出免費版限制):** **阻擋導航**。
        -   **阻擋 UI:** 阻擋導航時，應彈出一個提示對話框，說明已超出免費版限制，並提供「前往設定」（停用項目）或「立即升級」（導航至 `PaywallScreen`）的選項。


## 主內容區元件詳述

_(此區域的元件會根據動畫互動進行高度調整)_

-   **時間區間標題 (Time Range Header):**
    -   **位置:** 位於 `頂部 Header` 之下、`圓餅圖區塊` 之上。
    -   **UI:** 顯示當前頁面對應的時間區間文字（例如 "November" 或 "11月10日"），應作為水平分頁內容的一部分跟隨頁面滑動。

-   **圓餅圖區塊 (`PieChart`):**
    -   **圓餅圖 (甜甜圈圖):**
        -   **數據:** 視覺化顯示**當前時間區間**內、**所選帳戶**的、按**使用者自訂類別** (`categoryId`) 聚合的**支出**分佈。
        -   **圖表中心:** 應在甜甜圈圖的中心**同時**顯示「**總收入**」和「**總支出**」（例如：NT$0.00 / -NT$58,010.00）。
        -   **貨幣顯示邏輯 (總收入與總支出):**
            -   若所有選定的帳戶都使用**相同的貨幣**，則總收入與總支出以該貨幣顯示。
            -   否則 (即選定的帳戶包含多種貨幣)，總收入與總支出將**換算為基礎貨幣**顯示。
        -   **顏色邏輯 (演算法動態合併):**
            -   **步驟一：計算累積佔比**
                -   App 會將所有支出類別按總額降冪排列。
                -   從總額最高的類別開始累加其佔比。
            -   **步驟二：動態合併條件**
                -   圓餅圖上顯示的**總區塊數（包含「其他」）最多為 8 個**。
                -   App 將**最多獨立顯示 7 個類別**。
                -   **例外條件 (提前合併):** 如果在累加過程中，前 N 個類別的累積總額**已經達到或超過 75%**，且 N 小於 7，那麼從第 N+1 個類別開始，以及所有剩餘的類別，都將**立即合併**到「其他」區塊。
            -   **顏色應用:**
                -   所有獨立顯示的類別（最多 7 個）會使用單一色系（例如 App 主題藍色）的漸層色。**總額最高者顏色最深，依此類推**。
                -   「其他」區塊的顏色，應為該色系中最淺的顏色。

-   **總餘額區塊 (Balance Area):**
    -   **位置:** 位於**圓餅圖區塊**和**逐筆紀錄區塊**之間。
    -   **UI:** 一個獨立、醒目的橫幅，**僅**顯示「**總結餘**」（例如 `Balance -NT$58,010.00`）。
    -   **貨幣顯示邏輯:**
        -   若所有選定的帳戶都使用**相同的貨幣**，則總餘額以該貨幣顯示。
        -   否則 (即選定的帳戶包含多種貨幣)，總餘額將**換算為基礎貨幣**顯示。
    -   **計算註記:** 此處的「總結餘」計算**必須包含** `Transfer` 記錄（轉出視為支出、轉入視為收入），以正確反映所選帳戶範圍的現金流變化。

-   **逐筆紀錄區塊 (`FlatList`):**
    -   **UI:** 預設佔據螢幕下方剩餘高度，此區域**內部可垂直滾動**。
    -   **結構:** 此區塊應在內部**拆分為兩個子區塊**：「**支出區**」和「**收入區**」，並可帶有子標題（例如「支出」、「收入」）。預設「支出區」顯示在「收入區」上方。
    -   **數據:** 從「**本機資料庫 (Local DB)**」查詢**當前時間區間**內、**所選帳戶**的交易紀錄 (`Transactions` 和 `Transfers`)。
    -   **共同排序邏輯 (所有分組模式通用):**
        -   **頂層排序:** 無論是按日期或類別分組，**群組本身**（即日期群組或類別群組）應按其**總金額降冪排列**（金額大的群組在最上方）。
        -   **群組內排序:** 展開群組後，群組內的單筆交易應按 `transactionDate` **降冪排列**，若日期相同，則再按 `updatedOn` **降冪排列**，以確保最新編輯的紀錄顯示在最上方。
    -   **顯示模式 (可切換):** 根據**報表篩選 Modal** 中「列表分組區」的設定，在**支出區**和**收入區** *內部* 各自套用：
        -   **按類別分組模式:** **(預設模式)**
            -   將交易按 `categoryId` 匯總，顯示各類別總金額，並可點擊展開查看該類別下的交易明細。
        -   **按日期分組模式:**
            -   將交易按 `transactionDate` 匯總（例如 "11月12日"），顯示各日期總金額，並可點擊展開查看該日期下的交易明細。
    -   **顯示內容 (每筆交易):**
        -   **項目內容:** 顯示圖標、類別名稱、(可選) 帳戶名稱、(可選) 備註、**金額 (原始幣別)**。
        -   **圖示顏色邏輯:**
            -   **支出區圖示:** 圖示顏色**必須**與「圓餅圖」的「演算法顏色」連動。總額最高的類別（列表的第一項）圖示顏色最深，依此類推（遵循圓餅圖的動態合併邏輯）。
            -   **收入區圖示:** 圖示顏色應使用**統一、固定的主題色**（例如 App 的收入色，如綠色或黃色），不參與漸層計算。
        -   **換算金額:** 若該筆交易的幣別**非**基礎貨幣，應在其原始金額下方，以較小字體顯示**換算後的基礎貨幣金額**。
        -   **監聽變更 (Real-time Update):** 此列表應即時監聽「本機資料庫」的變更。當背景同步或定期交易任務寫入新資料時，UI 應自動刷新。
    -   **互動 (點擊):**
        -   **點擊單筆紀錄:** 導航至 `TransactionEditorScreen` 或 `TransferEditorScreen` (包含**管理**定期交易的入口)。


## 核心互動

-   **動畫互動 (折疊/展開):**
    -   **向上滾動 (展開列表):**
        1.  當使用者在**逐筆紀錄區塊**中向上滾動時，**圓餅圖區塊**動畫收合 (例如高度變為 0 或向上滑出螢幕)。
        2.  **圓餅圖區塊**完全收合後，**頂部 Header** 向上滑動隱藏，**底部 Footer** 向下滑動隱藏。
        3.  **逐筆紀錄區塊**動畫展開以填滿剩餘空間。
    -   **向下滾動 (恢復圖表與 Header/Footer):**
        1.  當使用者在 (已展開的)**逐筆紀錄區塊**中向下滾動至列表頂部 (scroll offset 0) 時，**圓餅圖區塊**動畫展開恢復顯示。
        2.  **圓餅圖區塊**完全展開後，**頂部 Header** 向下滑動顯示，**底部 Footer** 向上滑動顯示。
        3.  **逐筆紀錄區塊**動畫縮回原高度。

-   **時間區間切換:**
    -   **架構:** `主內容區 (View)` 本身應實作為一個**水平分頁 (Paging) 的 `ScrollView`**（或 `PagerView`）。
    -   **頁面:** `ScrollView` 中的**每一頁**都是一個獨立的儀表板實例，代表一個時間區間（例如 "11月", "12月", "1月"）。每一頁都包含自己的 `時間區間標題`、`圓餅圖區塊`、`總餘額區塊` 和 `逐筆紀錄區塊`。
    -   **手勢:**
        -   **水平滑動:** 當使用者在**非「逐筆紀錄區塊」**的區域（例如 `時間區間標題`、`圓餅圖區塊` 或 `總餘額區塊`）左右滑動時，觸發**整頁**切換，並顯示 Segue（卡片滑動）動畫。
        -   **垂直滑動:** 僅在 `逐筆紀錄區塊` 上觸發，用於滾動列表及連動 Header/Footer 的隱藏動畫。
    -   **行為:** 僅允許由當前期間向左（查看過去）滑動；嘗試往右進入今天以後的期間時需鎖定頁面並以 Toast/Banner 提示「不可瀏覽未來」，遵循 `no0_pending_discussion.md`。
    -   **資料更新:** 滑動操作會觸發新頁面的載入（Lazy Load）。

-   **報表篩選 Modal:**
    -   **觸發:** 使用者點擊 Header 左側的 `報表篩選按鈕`。
    -   **UI:** 彈出一個**底部彈出式 Modal (Bottom Sheet)**。
    -   **Modal 內部佈局:**
        -   **Modal 頂部導航列:**
            -   **元件:** 一個位於 Modal 頂部的標題列。
            -   **左側:** 「取消」按鈕（點擊後關閉 Modal，不儲存變更）。
            -   **中間:** 標題「篩選報表」。
            -   **右側:** 「完成」按鈕 (Done)。
            -   **「完成」按鈕邏輯:** 點擊後，Modal 關閉，`HomeScreen` 根據 Modal 內選定的「時間粒度」和「帳戶選項」，重新觸發**「本機資料庫」**的查詢，並更新主內容區的所有數據。
        -   **時間粒度區 (Time Granularity) (位於導航列下方):**
            -   **元件:** 一個分段控制項 (Segmented Control)。
            -   **選項:** "日", "週", "月", "年", "全部"。
            -   **邏輯:** 這是單選。
        -   **帳戶篩選區 (Account Filter):**
            -   **元件:** 一個可滾動的多選列表 (Checkbox list)，包含「全選」選項。
            -   **邏輯:** 此列表**必須**排除所有 `deletedOn` 或 `disabledOn` **非 `null`** 的帳戶。
            -   **限制:** 此列表**不受**免費版 3 個帳戶的數量限制。
        -   **列表分組區 (Grouping Area):**
            -   **元件:** 一個新的分段控制項 (Segmented Control)。
            -   **選項:** "按日期分組", "按類別分組"。
    -   **預設行為:**
        -   App 啟動時，時間粒度預設為「當日 (daily)」。
        -   帳戶篩選器預設僅選取 `sortOrder` 最高的帳戶（即 `sortOrder` 最小的項目）。
        -   列表分組預設為「按類別分組」。
    -   **未來限制:**
        -   Modal 內的日期/粒度控制不可跳到今天以後；若使用者嘗試選擇未來期間，需拒絕操作並提示原因。

-   **導航邏輯 (Navigation Logic):**
    -   當使用者點擊 Footer 中的新增支出/收入/轉帳按鈕時：
        -   **如果**當前 `HomeScreen` 的時間粒度為 `daily`，則導航至 `TransactionEditorScreen` 或 `TransferEditorScreen` 時，需傳入當前報表日期作為 `defaultDate` 參數。
        -   **否則**，正常導航，不傳遞日期參數。