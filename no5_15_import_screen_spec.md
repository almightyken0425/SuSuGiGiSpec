# 匯入畫面 (ImportScreen)

_(本文件定義「資料遷移」畫面的 UI、流程與邏輯)_

## 畫面目標 (Screen Objective)

* **_[付費功能]_**
- 提供一個引導式介面，讓使用者可以從 CSV 檔案**完整遷移**其交易紀錄。
    
- 支援 CSV 欄位與 App 欄位的映射。
    
- **支援 CSV 內容（如 "晚餐"）與 App 內容（如 "餐飲" 類別）的配對，並能自動建立新的帳戶與類別**，以達成「完美還原」。
    

## UI 佈局與元件 (UI Layout & Components)

此畫面應為一個多步驟的引導流程 (Wizard)。

### 步驟 1: 檔案選擇

- **頂部導航列:** 標題「匯入紀錄 (1/4)」。
    
- **UI:**
    
    - 「**選擇 CSV 檔案**」按鈕。
        
    - 說明文字 (例如 "支援 UTF-8 編碼")。
        
- **下一步按鈕:** 選擇檔案後才可點擊。
    

### 步驟 2: 欄位映射 (Column Mapping)

- **頂部導航列:** 標題「欄位映射 (2/4)」。
    
- **UI:**
    
    - **目標欄位 (App):** 「日期」、「金額」、「類別名稱」、「帳戶名稱」、「備註」。
        
    - **來源欄位 (CSV):** 每個目標欄位旁，都有一個下拉選單，讓使用者選擇對應的 CSV 欄位標頭。
        
- **邏輯:**
    
    - App 應嘗試自動猜測配對。
        
    - 使用者必須完成**必填**欄位 (日期, 金額, 類別, 帳戶) 的映射才能繼續。
        
- **下一步按鈕:** 必填欄位都完成映射後才可點擊。
    

### 步驟 3: 內容配對 (Value Mapping)

- **頂部導航列:** 標題「內容配對 (3/4)」。
    
- **UI:** 畫面分為兩個區塊：「**帳戶配對**」和「**類別配對**」。
    
- **帳戶配對區:**
    
    - **標題:** 「請配對您的帳戶」。
        
    - **列表:** App 會顯示所有從 CSV 中讀取到的不重複「帳戶名稱」(例如 "我的信用卡", "公司卡")。
        
    - **每一項的操作:**
        
        - **CSV 項目:** "我的信用卡"
            
        - **下拉選單 (操作):**
            
            - **選項 1 (自動建立):** `自動建立新帳戶 "我的信用卡"` (預設)
                
            - **選項 2 (配對現有):** `配對到 -> [富邦J卡]`
                
            - **選項 3 (配對現有):** `配對到 -> [現金]`
                
            - **選項 4 (略過):** `略過所有使用此帳戶的交易`
                
- **類別配對區:**
    
    - **標題:** 「請配對您的類別」。
        
    - **列表:** 顯示 CSV 中所有不重複的「類別名稱」(例如 "晚餐", "交通")。
        
    - **每一項的操作 (同上):**
        
        - **CSV 項目:** "晚餐"
            
        - **下拉選單 (操作):**
            
            - `自動建立新類別 "晚餐"` (預設)
                
            - `配對到 -> [餐飲]`
                
            - `略過所有使用此類別的交易`
                
- **下一步按鈕:** 使用者必須為**所有**偵測到的新名稱選好操作（自動建立、配對或略過）才能繼續。
    

### 步驟 4: 預覽與匯入

- **頂部導航列:** 標題「預覽與匯入 (4/4)」。
    
- **UI:**
    
    - **摘要資訊:**
        
        - `將匯入 N 筆交易`
            
        - `將自動建立 M 個新帳戶`
            
        - `將自動建立 K 個新類別`
            
    - **預覽列表:** 顯示前 5-10 筆**已配對完成**的交易紀錄，清楚顯示其將被歸入的（新或舊）帳戶與類別。
        
    - **警告:** 如有格式錯誤（如日期無法解析）導致略過的筆數，應在此顯示。
        
- **匯入按鈕:** 顯示「**開始匯入**」按鈕。
    

## 核心邏輯

- **付費牆檢查 (Paywall Check):**
    - **邏輯:** 由於此功能為付費版專屬，在「設定主頁」點擊導航時，就應檢查「**本機狀態 (e.g., PremiumContext)**」中的 `isPremiumUser` 狀態。
    - **若為免費版:** 應直接導航至「付費牆畫面」，不應進入此畫面。
- **CSV 解析 (步驟 1 -> 2):**
    
    - 使用者上傳檔案後，在客戶端進行 CSV 解析，讀取所有標頭和資料。
        
- **內容分析 (步驟 2 -> 3):**
    
    - App 根據「欄位映射」的設定，掃描 CSV 中的「帳戶名稱」和「類別名稱」欄位。
        
    - 建立這兩欄的不重複值列表 (e.g., `['我的信用卡', '公司卡']`)。
        
    - 將這些值與「**本機資料庫 (Local DB)**」中現有的 `Accounts` 和 `Categories` 名稱進行比對，自動標記出「新發現」的項目。
        
- **匯入執行 (步驟 4):**
    
    - 點擊「開始匯入」後，App 進入一個批次處理流程：
        
    - **1. 建立新項目:**
        - 根據「步驟 3」的設定，**優先**在「**本機資料庫 (Local DB)**」中批次建立所有新帳戶與類別（**必須**設定 `updatedOn` 時間戳記）。
    - **2. 匯入交易:**
        - **建立配對地圖:** 在記憶體中建立一個配對地圖 (e.g., `{"CSV名稱 '我的信用卡'": "App ID 'uuid-xyz-123'"}`)。
        - **遍歷 CSV:** 再次遍歷 CSV 檔案的每一行資料。
        - **組合資料:** 根據配對地圖，將 CSV 資料行轉換為 `Transaction` 物件，確保 `accountId` 和 `categoryId` 都已填上正確的 App 內部 ID。
        - **寫入:** 在「**本機資料庫 (Local DB)**」中批次寫入所有 `Transaction` 物件（**必須**設定 `updatedOn` 時間戳記）。
            
- **匯入完成:**
    
    - 顯示一個 Modal，提示「匯入完成！成功新增 N 筆紀錄、M 個帳戶、K 個類別。」
        
    - 點擊「完成」後，導航回 `SettingsScreen`。
        

## 錯誤處理

- **檔案選擇 (步驟 1):** 處理檔案類型、編碼錯誤。
    
- **欄位映射 (步驟 2):** 確保必填欄位 (日期、金額等) 均被映射。
    
- **內容配對 (步驟 3):** 確保所有新內容都被使用者指派了操作。
    
- **預覽 (步驟 4):** 必須清楚顯示因**資料格式**錯誤 (例如日期 "N/A"、金額 "abc") 而被略過的紀錄行數。
    

## 狀態管理 (State Management)

- `currentStep: number`
    
- `csvFile: File | null`
    
- `csvHeaders: string[]`
    
- `csvData: any[]`
    
- `columnMapping: { [appField: string]: string | null }`
    
- **`valueMapping: { accounts: Map, categories: Map }` (儲存步驟 3 的配對決策)**
    
- `parsedTransactions: Transaction[]` (預覽用的資料)
    
- `errorRows: any[]`
    

## 導航 (Navigation)

- **進入:** 從 `SettingsScreen` (或 `PreferenceScreen`) 的「匯入資料」項目點擊進入。
    
- **退出:** 點擊頂部導航列的「返回」按鈕，或在匯入成功後自動返回。