# 首頁畫面: HomeScreen

## 畫面目標

- **提供:** 使用者財務狀況的即時總覽
- **展示:** 收支分佈圓餅圖與逐筆交易紀錄
- **作為:** 快速新增交易與轉帳的入口
- **支援:** 多幣別換算與時間區間篩選

```text
+---------------------------------------+
| [Filter] [Logo] [Search] [Settings]   |
+---------------------------------------+
|       <  Time Period  >               |
|                                       |
|           Pie Chart                   |
|                                       |
|       Total Balance Area              |
+---------------------------------------+
| Mode 1: Group by Category       |
| Expense                               |
| [v] [Icon] Food           TWD 500.00  |
|     USD 10.00                  10/25  |
|     TWD 320 Converted                 |
|                                       |
|     TWD 180.00                 10/25  |
|                                       |
| Income                                |
| [v] [Icon] Salary       TWD 5,000.00  |
|     TWD 5,000.00               10/01  |
|                                       |
| Mode 2: Group by Date                 |
| Expense                               |
| [v] Oct 25                TWD 500.00  |
|     Food                   USD 10.00  |
|     Lunch w/ team            TWD 320  |
|                                       |
|     Transport             TWD 180.00  |
|                                       |
| Income                                |
| [v] Oct 01              TWD 5,000.00  |
|     Salary              TWD 5,000.00  |
+---------------------------------------+
| [+] Income [->] Transfer [-] Expense  |
+---------------------------------------+
```

---

## UI 佈局

- **頂部 Header:**
    - `報表篩選按鈕`
    - `Logo`
    - `搜尋按鈕`
    - `設定入口按鈕`
- **主內容區:**
    - `時間區間標題`
    - **圓餅圖區塊:**
        - `圓餅圖`
        - `支出數值`
        - `收入數值`
    - **總餘額區塊:**
        - `總餘額`
    - **逐筆紀錄區塊:**
        - **支出區:** 採用交易群組結構
        - **收入區:** 採用交易群組結構
        - **交易群組結構:**
            - **分組標題列:**
                - `收合圖示` Chevron
                - **分組標題:**
                    - **IF 類別分組:** 類別圖示
                    - **IF 日期分組:** 日期區間
                - **分組金額:** 
                    - **IF 單幣別:** 顯示原始幣別金額
                    - **IF 多幣別:** 主要貨幣換算金額
            - **單筆紀錄列:**
                - `交易類型圖示`
                    - **IF 定期交易:** 顯示循環圖示
                    - **ELSE:** 顯示一般圖示
                - **IF 類別分組:**
                    - `紀錄金額`
                        - **IF 單幣別:** 顯示原始幣別金額
                        - **IF 多幣別:** 顯示原始幣別金額 + 主要貨幣換算金額
                    - `備註`
                    - `日期`
                - **IF 日期分組:**
                    - `類別名稱`
                    - `備註`
                    - `紀錄金額`
                        - **IF 單幣別:** 顯示原始幣別金額
                        - **IF 多幣別:** 顯示原始幣別金額 + 主要貨幣換算金額
- **底部 Footer:**
    - `新增收入按鈕` 圖示 +
    - `新增轉帳按鈕` 圖示 →
    - `新增支出按鈕` 圖示 -

---

## 核心邏輯

- **資料處理:**
    - **圓餅圖區塊:**
        - **聚合:** 依 `categoryId`
        - **過濾:** `當前時間區間` + `所選帳戶`
        - **貨幣邏輯:**
            - **IF 單幣別:** 顯示該幣別
            - **IF 多幣別:**
                - **邏輯:** 依照 `CurrencyConversionLogic` 進行換算
                - **限制:** 僅使用直接對應基礎貨幣的匯率 `Currency A -> Base Currency`，不支援多層跳轉。
                - **例外:** 若無匯率則不計入或標示為未計算。
        - **顏色邏輯:**
            - **排序:** 支出類別依總額降冪排列
            - **合併條件:**
                - 總區塊數 <= 6
                - 總區塊數包含其他類別
                - 獨立顯示類別數 <= 5
            - **提前合併:** 若前 N 類別累計佔比 >= 5/6 且 N < 5，則 N+1 及其後併入其他
    - **總餘額區塊:**
        - **過濾:** `當前時間區間` + `所選帳戶`
        - **貨幣邏輯:**
            - **IF 單幣別:** 顯示原始幣別金額
            - **IF 多幣別:** 主要貨幣換算金額
    - **逐筆紀錄區塊:**
        - **來源:** 本機 DB
        - **過濾:** `當前時間區間` + `所選帳戶`
        - **第一層分組:** 固定分為支出與收入兩個區塊
        - **第二層分組:** 依 Filter Modal 選擇
            - 類別分組
            - 日期分組
        - **分組金額計算:**
            - **邏輯:** 依 Filter Modal 選擇的帳戶判斷
            - **IF 單幣別:** 顯示原始幣別金額
            - **IF 多幣別:** 顯示原始幣別金額 + 主要貨幣換算金額
        - **單筆紀錄:**
            - **紀錄金額:**
                - **IF 單幣別:** 顯示原始幣別金額
                - **IF 多幣別:** 顯示原始幣別金額 + 主要貨幣換算金額
        - **排序:**
            - **分組間:** 依總金額降冪
            - **分組內:** 依 `transactionDate` 降冪
- **互動:**
    - **逐筆紀錄列表:**
        - **點擊分組:** 展開或收合該分組列表
        - **點擊紀錄:** 導航至編輯畫面
    - **時間區間切換:**
        - **架構:** `主內容區` 為水平分頁 `ScrollView` Paging
        - **頁面:** 每一頁代表一個時間區間實例
        - **限制:** 禁止向未來日期區間滑動
        - **資料:** 滑動觸發新頁面 Lazy Load
        - **時間區間標題互動:** 跟隨水平分頁滑動
    - **動畫折疊與展開:**
        - **觸發向上滾動:** 於 `主內容區` 向上滾動
        - **展開列表流程:**
            - `圓餅圖區塊` 動畫收合
            - `頂部 Header` 向上隱藏
            - `底部 Footer` 向下隱藏
            - `逐筆紀錄區塊` 展開填滿
        - **觸發向下滾動:** 於 `主內容區` 滾動至頂部
            - **條件:** offset 0
        - **恢復圖表流程:**
            - `圓餅圖區塊` 動畫展開
            - `頂部 Header` 向下顯示
            - `底部 Footer` 向上顯示
            - `逐筆紀錄區塊` 縮回原高

---

## 導航

- **Header 按鈕導航:**
    - **觸發:** 點擊 `報表篩選按鈕`
    - **導航:** `HomeFilterScreen`

- **Footer 新增按鈕導航:**
    - **觸發:** Footer 支出、收入、轉帳按鈕點擊
    - **流程:**
        - **權限驗證:**
            - **驗證:** 讀取 `PremiumLogic.checkPremiumStatus()`
            - **IF True:** 執行導航
            - **IF False:** 執行限制檢查
            - **查詢本機 DB:**
                - `active_accounts` = `Accounts.Count`
                    - **條件:** deletedOn IS null AND disabledOn IS null
                - `active_categories` = `Categories.Count`
                    - **條件:** deletedOn IS null AND disabledOn IS null
            - **判斷:**
                - **IF** `active_accounts <= 3` AND `active_categories <= 10`: 執行導航
                - **ELSE:** 導航 PaywallScreen
        - **導航:**
            - **目標:** `TransactionEditorScreen` 或 `TransferEditorScreen`
            - **參數:**
                - **IF** `HomeScreen` 時間粒度為 daily:
                    - **參數:** defaultDate
                    - **值:** 當前報表日期
                - **ELSE:**
                    - **參數:** 無 defaultDate
