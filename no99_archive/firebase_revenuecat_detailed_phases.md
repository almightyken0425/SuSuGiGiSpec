# Firebase & RevenueCat 串接施工計劃 - 詳細子階段

> **文件日期:** 2026-01-03  
> **最後更新:** 2026-01-06  
> **版本:** v2.1 執行中版本  
> **母文件:** `firebase_revenuecat_integration_plan_20260103.md`  
> **執行狀態:** ✅ 階段0完成 | ✅ 階段2完成 | ✅ 階段3完成 | ✅ 階段4完成 | 🚀 階段5(測試)準備中

---

## 階段拆解總覽

(略)

## ✅ 階段 3: Firestore 資料同步 (已完成)

### ✅ 子階段 3.1: Firestore 基礎設定 (已完成)

(略)

### ✅ 子階段 3.2: Users Collection 實作 (已完成)

(略)

### ✅ 子階段 3.3: RevenueCat Firebase Extension 整合 (已完成)

**完成備註:**
- Schema 已對齊 `rc_entitlements` 與 `rc_active_subscriptions`
- 移除 App 端 `isPremium` 寫入權限，改由 Extension 處理

(略)

### ✅ 子階段 3.4: 偏好設定同步實作 (已完成)

(略)

### ✅ 子階段 3.5: SyncEngine 基礎框架 (已完成)

**完成備註:**
- `syncEngine.ts` 核心已實作
- 支援 Accounts, Categories, Transactions, Transfers, Rates, Schedules

(略)

### ✅ 子階段 3.6: Premium 升降級邏輯 (已完成)

**完成備註:**
- `PremiumContext` 整合 Sync 觸發
- 實作 Force Sync 機制

(略)

## ✅ 階段 4: 完整同步引擎 (已完成)

### ✅ 子階段 4.1: Firestore Collections Schema 設計 (已完成)

**完成備註:**
- 完整定義 6 大 Collection Schema
- 實作 Type Mapper (Local <-> Remote)

(略)

### ✅ 子階段 4.2: 增量同步實作 (已完成)

**完成備註:**
- 實作 `pullChanges` 與 `pushChanges`
- 實作 Last Write Wins (LWW) 衝突解決
- 實作 Soft Delete 同步

(略)

### ✅ 子階段 4.3: Initial Sync 實作 (已完成)

**完成備註:**
- 整合於 `sync()` 流程
- 支援分批處理 (Batch Size: 500)

(略)

### ✅ 子階段 4.4: 錯誤處理與重試 (已完成)

**完成備註:**
- 實作 `try-catch` 與錯誤 Log
- UI 顯示同步狀態與錯誤

(略)

### ✅ 子階段 4.5: SyncContext 與 UI 整合 (已完成)

**完成備註:**
- 整合於 `SettingsScreen`
- 實作 "Force Sync Now" 按鈕
- 實作 Database Reset 功能

---

## 階段 5: 整合測試與優化

### 子階段 5.1: 端到端測試

**預估時間:** 2 天

**工作內容:**
- 執行情境 1: 新使用者流程
- 執行情境 2: 升級流程
- 執行情境 3: 過期處理
- 執行情境 4: 恢復購買
- 執行情境 5: 離線使用
- 記錄測試結果
- 修復發現問題

**產出:**
- E2E 測試報告
- 問題與修復清單

**驗收標準:**
- 所有情境通過
- 無重大問題
- 使用者體驗良好

---

### 子階段 5.2: 效能優化

**預估時間:** 1 天

**工作內容:**
- 分析 Firestore 讀寫次數
- 實作智慧同步頻率
- 優化 WatermelonDB 查詢
- 優化 App 啟動時間
- 實作延遲載入
- 測試效能改善

**產出:**
- 效能優化報告
- 優化程式碼

**驗收標準:**
- Firestore 讀寫降低 30%
- App 啟動時間 < 3 秒
- 同步效能提升

---

### 子階段 5.3: 成本監控與錯誤追蹤

**預估時間:** 1 天

**工作內容:**
- 整合 Firebase Crashlytics
- 設定錯誤追蹤
- 建立成本監控儀表板
- 設定 Firestore 預算警報
- 設定 RevenueCat 監控
- 建立關鍵指標追蹤

**產出:**
- Crashlytics 設定
- 成本監控儀表板
- 指標追蹤報告

**驗收標準:**
- Crashlytics 正常運作
- 成本監控準確
- 指標可視化

---

### 子階段 5.4: 文件更新與審查

**預估時間:** 1 天

**工作內容:**
- 更新 README
- 建立環境設定指南
- 建立故障排除文件
- 補充程式碼註解
- 建立 API 文件
- 審查 Security Rules
- 執行 Rules 測試

**產出:**
- 完整文件集
- Security Rules 審查報告

**驗收標準:**
- 文件完整清晰
- Security Rules 無漏洞
- 新成員可依文件上手

---

## 時程規劃建議

### 超快速路徑: 2 週

**適合:** 全職開發，已有 Firebase 經驗

- **週 1:** 階段 0 + 階段 1 + 階段 2.1~2.4
- **週 2:** 階段 2.5~2.7 + 階段 3 + 階段 4 + 階段 5

### 快速路徑: 4 週

**適合:** 全職開發，邊學邊做

- **週 1:** 階段 0 + 階段 1
- **週 2:** 階段 2
- **週 3:** 階段 3 + 階段 4.1
- **週 4:** 階段 4.2~4.5 + 階段 5

### 穩健路徑: 6 週

**適合:** 兼職開發，充分測試

- **週 1-2:** 階段 0 + 階段 1
- **週 3:** 階段 2.1~2.4
- **週 4:** 階段 2.5~2.7 + 階段 3.1~3.3
- **週 5:** 階段 3.4~3.6 + 階段 4
- **週 6:** 階段 5

### 謹慎路徑: 8 週

**適合:** 業餘時間開發，品質優先

- **週 1:** 階段 0
- **週 2:** 階段 1
- **週 3:** 階段 2.1~2.4
- **週 4:** 階段 2.5~2.7
- **週 5:** 階段 3.1~3.3
- **週 6:** 階段 3.4~3.6
- **週 7:** 階段 4
- **週 8:** 階段 5

---

## 階段依賴關係

### 必須依序執行

- 0.1 → 0.2 → 0.3
- 1.1 → 1.2 → 1.3 → 1.4
- 2.1 → 2.2 → 2.3 & 2.4 → 2.5 → 2.6 → 2.7
- 3.1 → 3.2 → 3.3 & 3.4 → 3.5 → 3.6
- 4.1 → 4.2 & 4.3 → 4.4 → 4.5
- 5.1 → 5.2 → 5.3 → 5.4

### 可平行執行

- 2.3 與 2.4 可同時進行
- 3.3 與 3.4 可同時進行
- 4.2 與 4.3 可同時進行
- 5.2 與 5.3 可同時進行

---

## 檢查清單模板

每個子階段完成後填寫：

```markdown
## 子階段 X.Y 完成檢查

- [ ] 所有工作項目已完成
- [ ] 產出文件已建立
- [ ] 驗收標準全部通過
- [ ] 程式碼已提交 Git
- [ ] 團隊已審查
- [ ] 可進入下一子階段
```

---

**文件結束**
