# 核心功能規格

## 資料流

- **觸發:** 新增交易或轉帳後
    
- **資料儲存:** 本機 DB
    
- **狀態更新:** 觸發
    
- **導航:** 返回 HomeScreen
    
- **HomeScreen:**
    
    - 偵測狀態變動
        
    - 重新計算報表數據
        
	- UI 重新渲染
    

## 多幣別處理

- **基礎貨幣:**
    
    - **初始化:** 依裝置地區設定
        
    - **使用者設定:** 可於設定中更改
        
- **帳戶建立流程: 付費功能**
    
    - **觸發:** 建立帳戶幣別非基礎貨幣
        
    - **行為:** 必須輸入該貨幣對基礎貨幣的初始匯率
        
    - **提示:**
        
        - 此匯率將用於未來報表換算
            
        - 報表一律採用最新一筆匯率記錄
            
    - **儲存:**
        
        - 初始匯率存入 CurrencyRates
            
        - RateDate 設為當日 00:00:00 UTC
            
- **報表顯示邏輯:**
    
    - **目標:** 顯示幣別依篩選的帳戶決定
        
    - **IF** 篩選帳戶皆為同幣別:
        
        - **顯示:** 該幣別
            
    - **ELSE** 篩選帳戶為多幣別:
        
        - **顯示:** 換算為基礎貨幣
            
- **報表計算方式:**
    
    - **篩選條件:** 時間粒度, 時間區間, 納入統計的帳戶列表
        
    - **遍歷:** 所有 Transactions 與 Transfers
        
    - **過濾:** 逐筆檢查
        
        - TransactionDate 於時間範圍內
            
        - AccountId 於帳戶列表內
            
        - DeletedOn 為 null
            
    - **納入計算:** 滿足所有條件的記錄
        
- **價值計算: 換算為基礎貨幣**
    
    - **IF** 記錄類型為 Transfer:
        
        - **IF** AccountFromId 在篩選範圍內: **視為** 支出
            
        - **IF** AccountToId 在篩選範圍內: **視為** 收入
            
    - **IF** 記錄類型為 Transaction:
        
        - **條件:** 交易為非基礎貨幣
            
        - **查詢:** CurrencyRates 取得最新一筆匯率
            
        - **計算:** 使用 latestRate.RateCents 換算為基礎貨幣 Cents
            
- **金額加總:** 依 CategoryType 分別加總
    
- **計算結餘:** 總收入 - 總支出
    
- **逐筆紀錄列表顯示:**
    
    - **金額:** 顯示原始幣別及符號
        
    - **換算:** 可選顯示換算後的基礎貨幣金額
        
- **備註: 匯率設計原則**
    
    - **報表計算分離:** 報表總資產計算, Transfers 價值流動基於 AmountFrom/To, CurrencyRates 用於換算非基礎貨幣的 Transactions
        
    - **自動記錄:** 跨幣別轉帳會自動新增隱含匯率至 CurrencyRates
        
    - **手動覆蓋:** 需提供手動管理匯率功能, 允許輸入新市場匯率, 覆蓋舊匯率
        
    - **API:** 不串接第三方匯率 API
        

## 報表功能

- **主要報表: 首頁**
    
    - **UI:** 儀表板卡片, 摘要視圖甜甜圈圖
        
    - **預設值:**
        
        - **顯示:** App 開啟時
            
        - **篩選:** 選取所有帳戶
            
        - **時間:** 當日, daily
            

## 使用者認證與同步

- **登入方式:** 強制 Google 登入
    
- **UserId:** Email
    
- **架構模型:** 本地優先 Local-First
    
- **資料操作:** App 所有讀寫一律針對 本機 DB
    
- **雲端角色:** 付費版使用者的被動備份與同步伺服器
    
- **同步模型:** 增量批次同步 Delta Batch Sync
    
- **首次登入流程:**
    
    - **觸發:** Google 登入成功, 取得 UserId
        
    - **IF** 新用戶:
        
        - **行為:**
            
            - 在 本機 DB 建立預設資料
                
            - 不執行任何雲端上傳或同步
                
    - **IF** 舊用戶:
        
        - **行為:** 不執行任何操作
            
        - **備註:** 資料將於升級 Premium 並首次觸發同步時下載
            
    - **導航:** 前往首頁
        
- **多裝置同步策略:**
    
    - **策略:** 支援多裝置同時登入
        
    - **理由:** 避免操作摩擦, 解決離線後資料不一致問題
        
    - **實現:** 核心資料表採 Append-Only, 避免 UPDATE 競爭
        

## AI 分析整合

- **定位:** 非 MVP 功能
    
- **觸發點:** 設定開關 或 首頁健檢按鈕
    
- **使用者同意:** 強制要求
    
- **互動方式:** Modal 視窗
    
- **評估:** 需後續評估 價值, 成本, 付費意願
    

## 設定功能

- **第一層入口:**
    
    - 類別管理
        
    - 帳戶管理
        
    - 匯率管理
        
    - 偏好設定
        
- **偏好設定: 第二層**
    
    - **語系:**
        
        - 切換顯示語言
            
    - **主要貨幣:**
        
        - 設定基礎貨幣
            
    - **時區:**
        
        - **功能:** 設定主要時區, 預設自動偵測, 儲存 IANA ID
            
        - **應用:**
            
            - **顯示:** App 內所有日期時間, 均使用主要時區格式化 UTC
                
            - **計算:** 報表時間邊界, 均以此主要時區為準
                
            - **定期交易:** lastRecurringCheckDate 檢查基於此時區
                
        - **出國情境:**
            
            - **查看:** App 忽略裝置當前時區, 始終使用主要時區
                
            - **新增:** 日期選擇器預設為裝置本地時間, 儲存時轉換為 UTC
                
    - **資料同步: 付費功能**
        
        - **立即同步:**
            
            - **行為:** 手動觸發與雲端同步
                
            - **備註:** 包含冷卻機制
                
    - **帳號:**
        
        - **登出:**
            
            - 觸發登出流程
                

## 定期交易

- **設定入口:** 交易/轉帳 編輯器
    
- **建立邏輯:**
    
    - **觸發:** 儲存新定期交易時
        
    - **行為:**
        
        - 於 Schedules 表建立新排程
            
        - 立即為 StartOn 日期產生第一筆交易實例
            
- **資料儲存: Schedules Table**
    
    - **欄位:** IsTransfer, TemplateAmountCents/From/To, TemplateCategoryId, TemplateAccountId/From/To, TemplateNote
        
- **補產生邏輯:**
    
    - **觸發:** App 啟動時檢查
        
    - **條件:** currentDateInUserTZ > lastRecurringCheckDate
        
    - **遍歷:** 有效 Schedules
        
    - **計算:** lastRecurringCheckDate 到 currentDateInUserTZ 應產生的日期 instanceDate
        
    - **檢查重複:** 存在即跳過
        
        - **條件:** 檢查 Transactions/Transfers 表是否存在 ScheduleId + ScheduleInstanceDate
            
        - **備註:** 不論 DeletedOn 狀態
            
    - **產生交易:**
        
        - **IF** 不存在: 創建新記錄
            
        - **IF** 已存在: 跳過
            
    - **更新:** lastRecurringCheckDate 為 currentDateInUserTZ
        
- **編輯刪除行為:**
    
    - **觸發:** 操作由定期交易產生的交易
        
    - **UI:** 顯示選項
        
    - **選項:**
        
        - **僅此一筆 - 編輯:**
            
            - **行為:** 直接修改該筆 Transaction / Transfer
                
        - **僅此一筆 - 刪除:**
            
            - **行為:** 軟刪除該筆 Transaction / Transfer
                
        - **此筆及未來所有 - 編輯:**
            
            - **行為:**
                
                - 將原 Schedule 的 EndOn 設為此交易日期的前一週期
                    
                - 根據新內容創建一個新 Schedule
                    
                - 不修改任何歷史記錄
                    
        - **此筆及未來所有 - 刪除:**
            
            - **行為:**
                
                - 將原 Schedule 的 EndOn 設為此交易日期的前一週期
                    
                - 不修改任何歷史記錄
                    

## 搜尋交易

- 僅搜尋 Transaction / Transfer 表中的 Note 欄位關鍵字
    

## 匯入資料

- CSV 匯入交易
    

## 快速捕捉小工具

- 規格已移至未來考量文件